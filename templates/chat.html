<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat - Crypto Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/14.1.0/markdown-it.min.js"></script>
    <style>
      :root {
        --bg: #eef4f7;
        --ink: #0f1f2e;
        --line: #d6e0e8;
        --brand: #0d9488;
        --brand-deep: #0f766e;
        --soft: #f7fafc;
      }
      body {
        background:
          radial-gradient(1200px 500px at -10% -10%, #d7f0ff 0%, transparent 50%),
          radial-gradient(1000px 400px at 120% 0%, #dff7ef 0%, transparent 50%),
          var(--bg);
        color: var(--ink);
      }
      .scroll-thin::-webkit-scrollbar { width: 8px; height: 8px; }
      .scroll-thin::-webkit-scrollbar-thumb { background: #bfd0dc; border-radius: 10px; }
      .bubble-user { background: linear-gradient(145deg, #0d9488, #0f766e); color: #fff; }
      .bubble-ai { background: #fff; border: 1px solid var(--line); }
      .bubble-tool { background: #fff7ed; border: 1px solid #fed7aa; }
      
      /* Styles for code blocks */
      .prose pre {
        position: relative;
        background-color: #2d2d2d;
        border-radius: 0.5rem;
        padding: 1rem;
        color: #f8f8f2;
      }
      .prose pre code.hljs {
        display: block;
        overflow-x: auto;
        padding: 0;
        background: transparent;
      }
      .copy-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background-color: #444;
        color: #ccc;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
      }
      .prose pre:hover .copy-btn {
        opacity: 1;
      }
      .copy-btn:hover {
        background-color: #555;
      }
    </style>
  </head>
  <body class="h-screen overflow-hidden">
    <div id="authView" class="h-screen flex items-center justify-center px-4" {% if authed %}style="display:none"{% endif %}>
      <div class="w-full max-w-sm rounded-2xl border border-slate-200 bg-white/95 p-6 shadow-xl">
        <h1 class="text-xl font-semibold tracking-tight">聊天访问验证</h1>
        <p class="mt-2 text-sm text-slate-500">输入密码后进入会话管理与聊天</p>
        <input id="password" type="password" class="mt-4 w-full rounded-xl border border-slate-300 px-3 py-2.5 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100" placeholder="Password" />
        <button onclick="login()" class="mt-3 w-full rounded-xl bg-teal-700 text-white py-2.5 hover:bg-teal-800 transition">进入聊天</button>
        <p id="authErr" class="mt-2 text-sm text-rose-600"></p>
      </div>
    </div>

    <div id="chatView" class="h-screen p-3 sm:p-4" {% if not authed %}style="display:none"{% endif %}>
      <div class="h-full grid grid-cols-1 lg:grid-cols-[340px_1fr] gap-3 sm:gap-4">
        <aside class="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur shadow-sm overflow-hidden flex flex-col min-h-0">
          <div class="p-3 border-b border-slate-200 bg-slate-50/70">
            <div class="flex items-center justify-between gap-2">
              <h2 class="font-semibold">会话管理</h2>
              <button onclick="openNewSession()" class="text-sm rounded-lg bg-teal-700 text-white px-3 py-1.5 hover:bg-teal-800">新建</button>
            </div>
            <div class="mt-2 flex items-center gap-2">
              <button id="multiBtn" onclick="toggleMultiSelect()" class="text-xs rounded-lg border border-slate-300 px-2 py-1 hover:bg-slate-100">多选</button>
              <button id="deleteSelectedBtn" onclick="deleteSelectedSessions()" class="hidden text-xs rounded-lg bg-rose-600 text-white px-2 py-1 hover:bg-rose-700">删除选中</button>
              <span id="selectedCount" class="hidden text-xs text-slate-500"></span>
            </div>
          </div>
          <div id="sessionList" class="flex-1 min-h-0 overflow-y-auto scroll-thin"></div>
        </aside>

        <section class="rounded-2xl border border-slate-200 bg-white/95 shadow-sm flex flex-col overflow-hidden min-h-0">
          <div class="px-4 py-3 border-b border-slate-200 bg-slate-50/60">
            <div id="chatHeader" class="text-sm text-slate-700">请选择或新建会话</div>
          </div>

          <div id="messages" class="flex-1 min-h-0 overflow-y-auto scroll-thin p-3 sm:p-4 bg-[linear-gradient(180deg,#f8fbff_0%,#f4f8fb_100%)] space-y-3"></div>

          <div id="approvalBar" class="hidden border-t border-amber-200 bg-amber-50 px-4 py-3">
            <div class="text-sm">
              <span class="font-semibold text-amber-800">工具调用待确认：</span>
              <span id="approvalText" class="text-amber-900"></span>
            </div>
            <div class="mt-2 flex gap-2">
              <button onclick="respondApproval(true)" class="rounded-lg bg-emerald-600 text-white px-3 py-1.5 text-sm hover:bg-emerald-700">同意执行</button>
              <button onclick="respondApproval(false)" class="rounded-lg bg-rose-600 text-white px-3 py-1.5 text-sm hover:bg-rose-700">拒绝</button>
            </div>
          </div>

          <div class="p-3 border-t border-slate-200 bg-white">
            <div class="flex gap-2">
              <textarea id="input" rows="2" class="flex-1 rounded-xl border border-slate-300 px-3 py-2.5 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 resize-none" placeholder="输入消息... Shift+Enter 换行，Enter 发送"></textarea>
              <button onclick="sendMessage()" class="self-end rounded-xl bg-teal-700 text-white px-4 py-2.5 hover:bg-teal-800">发送</button>
            </div>
          </div>
        </section>
      </div>
    </div>

    <div id="newSessionModal" class="hidden fixed inset-0 bg-black/45 p-4 flex items-center justify-center">
      <div class="w-full max-w-md rounded-2xl bg-white border border-slate-200 p-4 shadow-xl">
        <h3 class="font-semibold">新建会话</h3>
        <p class="text-sm text-slate-500 mt-1">请选择交易对配置</p>
        <select id="configSelect" class="mt-3 w-full rounded-xl border border-slate-300 px-3 py-2.5"></select>
        <input id="sessionTitle" class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2.5" placeholder="会话标题（可选）" />
        <div class="mt-3 flex justify-end gap-2">
          <button onclick="closeNewSession()" class="rounded-lg border border-slate-300 px-3 py-1.5">取消</button>
          <button onclick="createSession()" class="rounded-lg bg-teal-700 text-white px-3 py-1.5">创建</button>
        </div>
      </div>
    </div>

    <script>
      let currentSessionId = null;
      let sessions = [];
      let configs = [];
      let pendingApproval = null;
      let currentMessages = [];
      let multiSelectMode = false;
      let selectedSessionIds = new Set();

      const md = window.markdownit({
        html: false,
        linkify: true,
        typographer: true,
        highlight: function (str, lang) {
          if (lang && hljs.getLanguage(lang)) {
            try {
              return '<pre class="hljs"><code>' +
                     hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                     '</code></pre>';
            } catch (__) {}
          }
          return '<pre class="hljs"><code>' + md.utils.escapeHtml(str) + '</code></pre>';
        }
      });

      function renderMarkdown(content) {
        return md.render(content);
      }

      document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('input');
        if (input) {
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage();
            }
          });
        }
      });

      async function login() {
        const password = document.getElementById('password').value;
        const res = await fetch('/api/chat/auth', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({password})
        });
        const data = await res.json();
        if (!data.success) {
          document.getElementById('authErr').textContent = data.message || '认证失败';
          return;
        }
        document.getElementById('authView').style.display = 'none';
        document.getElementById('chatView').style.display = 'block';
        await bootstrap();
      }

      async function bootstrap() {
        const res = await fetch('/api/chat/bootstrap');
        const data = await res.json();
        if (!data.success) return;
        sessions = data.sessions || [];
        configs = data.configs || [];
        if (currentSessionId && !sessions.some(s => s.session_id === currentSessionId)) {
          currentSessionId = null;
          currentMessages = [];
        }
        renderSessions();
      }

      function toggleMultiSelect() {
        multiSelectMode = !multiSelectMode;
        if (!multiSelectMode) selectedSessionIds.clear();
        renderSessions();
      }

      function toggleSelected(sessionId, checked) {
        if (checked) selectedSessionIds.add(sessionId);
        else selectedSessionIds.delete(sessionId);
        updateSelectionMeta();
      }

      function updateSelectionMeta() {
        const delBtn = document.getElementById('deleteSelectedBtn');
        const count = document.getElementById('selectedCount');
        if (!multiSelectMode) {
          delBtn.classList.add('hidden');
          count.classList.add('hidden');
          return;
        }
        delBtn.classList.remove('hidden');
        count.classList.remove('hidden');
        count.textContent = `已选 ${selectedSessionIds.size}`;
      }

      function renderSessions() {
        const list = document.getElementById('sessionList');
        const multiBtn = document.getElementById('multiBtn');
        multiBtn.textContent = multiSelectMode ? '退出多选' : '多选';
        multiBtn.className = multiSelectMode
          ? 'text-xs rounded-lg border border-teal-600 text-teal-700 px-2 py-1 bg-teal-50'
          : 'text-xs rounded-lg border border-slate-300 px-2 py-1 hover:bg-slate-100';
        updateSelectionMeta();

        if (!sessions.length) {
          list.innerHTML = '<div class="p-4 text-sm text-slate-500">暂无会话</div>';
          return;
        }

        list.innerHTML = sessions.map(s => {
          const active = s.session_id === currentSessionId;
          const selected = selectedSessionIds.has(s.session_id);
          return `
            <div class="group border-b border-slate-100 ${active ? 'bg-teal-50/70' : 'hover:bg-slate-50'}">
              <div class="p-3 flex items-start gap-2">
                ${multiSelectMode ? `<input type="checkbox" ${selected ? 'checked' : ''} onchange="toggleSelected('${s.session_id}', this.checked)" class="mt-1 h-4 w-4" />` : ''}
                <button onclick="selectSession('${s.session_id}')" class="flex-1 text-left min-w-0">
                  <div class="font-medium text-sm truncate">${escapeHtml(s.title || s.symbol)}</div>
                  <div class="text-xs text-slate-500 mt-1 truncate">${escapeHtml(s.symbol)} · ${escapeHtml(s.config_id)}</div>
                </button>
                <button onclick="deleteOneSession('${s.session_id}')" class="opacity-0 group-hover:opacity-100 transition text-xs rounded-md border border-rose-200 text-rose-600 px-2 py-1 hover:bg-rose-50">删</button>
              </div>
            </div>
          `;
        }).join('');
      }

      async function selectSession(sessionId) {
        if (multiSelectMode) return;
        currentSessionId = sessionId;
        pendingApproval = null;
        showApproval();
        renderSessions();

        const res = await fetch(`/api/chat/sessions/${sessionId}/messages`);
        const data = await res.json();
        if (!data.success) return;
        document.getElementById('chatHeader').textContent = `${data.session.title} (${data.session.symbol} / ${data.session.config_id})`;
        currentMessages = data.messages || [];
        renderMessages(currentMessages);
      }

      function renderMessages(messages) {
        const container = document.getElementById('messages');
        container.innerHTML = '';

        if (!messages.length) {
          container.innerHTML = '<div class="text-center text-sm text-slate-400 mt-8">暂无消息，开始对话吧</div>';
          return;
        }

        messages.forEach(m => {
          const isUser = m.role === 'user';
          const isTool = m.role === 'tool';
          const bubbleClass = isUser ? 'bubble-user ml-auto max-w-[82%]' : (isTool ? 'bubble-tool max-w-[90%]' : 'bubble-ai max-w-[90%]');
          const roleText = isUser ? '你' : (isTool ? 'Tool' : 'Agent');
          const el = document.createElement('div');
          el.className = `rounded-2xl px-3 py-2.5 text-sm break-words shadow-[0_1px_2px_rgba(15,23,42,0.04)] ${bubbleClass}`;
          
          let contentHtml;
          if (m.content) {
              if (isUser) {
                  contentHtml = escapeHtml(m.content);
              } else {
                  contentHtml = renderMarkdown(m.content);
              }
          } else {
              contentHtml = '<div class="h-4 w-1 animate-pulse bg-slate-300 rounded"></div>'; // Simple loading state
          }
          
          el.innerHTML = `<div class="text-[11px] opacity-70 mb-1">${roleText}</div><div class="prose prose-sm max-w-none">${contentHtml}</div>`;
          container.appendChild(el);
        });

        // Add copy buttons to new code blocks
        container.querySelectorAll('pre').forEach(pre => {
          if (pre.querySelector('.copy-btn')) return; // a lready has a button
          const code = pre.querySelector('code');
          if (!code) return;

          const btn = document.createElement('button');
          btn.textContent = 'Copy';
          btn.className = 'copy-btn';
          btn.onclick = () => {
            navigator.clipboard.writeText(code.textContent).then(() => {
              btn.textContent = 'Copied!';
              setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
            });
          };
          pre.appendChild(btn);
        });

        container.scrollTop = container.scrollHeight;
      }

      async function sendMessage() {
        if (!currentSessionId || pendingApproval) return;
        const input = document.getElementById('input');
        const message = input.value.trim();
        if (!message) return;
        input.value = '';
        input.disabled = true;

        currentMessages.push({ role: 'user', content: message });
        currentMessages.push({ role: 'assistant', content: '' });
        const streamAssistantIndex = currentMessages.length - 1;
        renderMessages(currentMessages);

        const eventSource = new EventSource(`/api/chat/sessions/${currentSessionId}/stream?message=${encodeURIComponent(message)}`);

        eventSource.onmessage = function(event) {
          const payload = JSON.parse(event.data);

          if (payload.type === 'chunk') {
            currentMessages[streamAssistantIndex].content += payload.content || '';
            renderMessages(currentMessages);
          } else if (payload.type === 'done') {
            // Final update and cleanup
            renderMessages(currentMessages);
            eventSource.close();
            input.disabled = false;
            input.focus();
            bootstrap(); // Refresh session list to show updated timestamp
          } else if (payload.type === 'error') {
            alert(payload.message || '流式传输失败');
            eventSource.close();
            input.disabled = false;
          }
        };

        eventSource.onerror = function() {
          alert('与服务器的连接丢失。');
          eventSource.close();
          input.disabled = false;
        };
      }

      async function respondApproval(approved) {
        if (!currentSessionId || !pendingApproval) return;
        const res = await fetch(`/api/chat/sessions/${currentSessionId}/send`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({approval: approved})
        });
        const data = await res.json();
        if (!data.success) {
          alert(data.message || '审批失败');
          return;
        }
        currentMessages = data.messages || [];
        renderMessages(currentMessages);
        pendingApproval = data.pending_approval || null;
        showApproval();
        await bootstrap();
      }

      function showApproval() {
        const bar = document.getElementById('approvalBar');
        const txt = document.getElementById('approvalText');
        if (!pendingApproval || !pendingApproval.value) {
          bar.classList.add('hidden');
          txt.textContent = '';
          return;
        }
        const v = pendingApproval.value;
        txt.textContent = `${v.tool_name}(${JSON.stringify(v.tool_args)})`;
        bar.classList.remove('hidden');
      }

      async function deleteOneSession(sessionId) {
        if (!confirm('确定删除这个会话吗？')) return;
        const res = await fetch(`/api/chat/sessions/${sessionId}`, { method: 'DELETE' });
        const data = await res.json();
        if (!data.success) {
          alert(data.message || '删除失败');
          return;
        }

        selectedSessionIds.delete(sessionId);
        if (currentSessionId === sessionId) {
          currentSessionId = null;
          currentMessages = [];
          pendingApproval = null;
          showApproval();
          document.getElementById('chatHeader').textContent = '请选择或新建会话';
          renderMessages([]);
        }
        await bootstrap();
      }

      async function deleteSelectedSessions() {
        if (!selectedSessionIds.size) return;
        if (!confirm(`确定删除选中的 ${selectedSessionIds.size} 个会话吗？`)) return;

        const ids = Array.from(selectedSessionIds);
        const res = await fetch('/api/chat/sessions', {
          method: 'DELETE',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ session_ids: ids })
        });
        const data = await res.json();
        if (!data.success) {
          alert(data.message || '批量删除失败');
          return;
        }

        if (currentSessionId && selectedSessionIds.has(currentSessionId)) {
          currentSessionId = null;
          currentMessages = [];
          pendingApproval = null;
          showApproval();
          document.getElementById('chatHeader').textContent = '请选择或新建会话';
          renderMessages([]);
        }
        selectedSessionIds.clear();
        multiSelectMode = false;
        await bootstrap();
      }

      function openNewSession() {
        const select = document.getElementById('configSelect');
        select.innerHTML = configs.map(c => `<option value="${c.config_id}">${escapeHtml(c.symbol)} · ${escapeHtml(c.config_id)} · ${escapeHtml(c.mode)}</option>`).join('');
        document.getElementById('sessionTitle').value = '';
        document.getElementById('newSessionModal').classList.remove('hidden');
      }

      function closeNewSession() {
        document.getElementById('newSessionModal').classList.add('hidden');
      }

      async function createSession() {
        const configId = document.getElementById('configSelect').value;
        const title = document.getElementById('sessionTitle').value.trim();
        const res = await fetch('/api/chat/sessions', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ config_id: configId, title })
        });
        const data = await res.json();
        if (!data.success) {
          alert(data.message || '创建失败');
          return;
        }
        closeNewSession();
        await bootstrap();
        await selectSession(data.session.session_id);
      }

      function escapeHtml(str) {
        return String(str || '').replace(/[&<>"']/g, (s) => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[s]));
      }

      {% if authed %}
      bootstrap();
      {% endif %}
    </script>
  </body>
</html>
