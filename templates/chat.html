<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat - Crypto Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
    <style>
      .scroll-thin::-webkit-scrollbar { width: 8px; height: 8px; }
      .scroll-thin::-webkit-scrollbar-thumb { background: #bfd0dc; border-radius: 10px; }
      .bubble-user { background: linear-gradient(145deg, #2563eb, #1d4ed8); color: #fff; }
      .bubble-ai { background: #fff; border: 1px solid #d8e1ee; }
      .bubble-tool { background: #fffbeb; border: 1px solid #fde68a; }
      .prose {
        max-width: 100%;
        overflow-wrap: anywhere;
        word-break: break-word;
      }
      .prose table {
        display: block;
        width: 100%;
        max-width: 100%;
        overflow-x: auto;
        border-collapse: collapse;
      }
      .prose th,
      .prose td {
        white-space: normal;
        word-break: break-word;
        vertical-align: top;
      }
      .prose pre {
        position: relative;
        max-width: 100%;
        overflow-x: auto;
      }
      .tool-args {
        white-space: pre-wrap;
        word-break: break-word;
        overflow-wrap: anywhere;
      }
      .copy-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background-color: #444;
        color: #ccc;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
      }
      .prose pre:hover .copy-btn {
        opacity: 1;
      }
      .copy-btn:hover {
        background-color: #555;
      }
      .typing-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: #94a3b8;
        display: inline-block;
        animation: bounce 1.1s infinite ease-in-out;
      }
      .typing-dot:nth-child(2) { animation-delay: 0.15s; }
      .typing-dot:nth-child(3) { animation-delay: 0.3s; }
      @keyframes bounce {
        0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
        40% { transform: translateY(-4px); opacity: 1; }
      }
      .mobile-bubble-max { max-width: 96%; }
    </style>
  </head>
  <body class="h-screen overflow-hidden bg-slate-100 text-slate-900">
    <div id="authView" class="h-screen flex items-center justify-center px-4" {% if authed %}style="display:none"{% endif %}>
      <div class="w-full max-w-sm rounded-2xl border border-slate-200 bg-white/95 p-6 shadow-xl">
        <h1 class="text-xl font-semibold tracking-tight">聊天访问验证</h1>
        <p class="mt-2 text-sm text-slate-500">输入密码后进入会话管理与聊天</p>
        <input id="password" type="password" class="mt-4 w-full rounded-xl border border-slate-300 px-3 py-2.5 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="Password" />
        <button onclick="login()" class="mt-3 w-full rounded-xl bg-blue-700 text-white py-2.5 hover:bg-blue-800 transition">进入聊天</button>
        <p id="authErr" class="mt-2 text-sm text-rose-600"></p>
      </div>
    </div>

    <div id="chatView" class="h-[100dvh] p-2 sm:p-4" {% if not authed %}style="display:none"{% endif %}>
      <div id="mobileOverlay" onclick="closeMobileSidebar()" class="hidden fixed inset-0 bg-black/35 z-30 lg:hidden"></div>
      <div class="relative h-full lg:grid lg:grid-cols-[340px_1fr] gap-3 sm:gap-4">
        <aside id="sessionSidebar" class="fixed z-40 inset-y-2 left-2 w-[88vw] max-w-[360px] -translate-x-[110%] transition-transform duration-200 rounded-2xl border border-slate-200 bg-white/95 backdrop-blur shadow-sm overflow-hidden flex flex-col min-h-0 lg:static lg:z-auto lg:inset-auto lg:w-auto lg:max-w-none lg:translate-x-0">
          <div class="p-3 border-b border-slate-200 bg-slate-50/70">
            <div class="flex items-center justify-between gap-2">
              <h2 class="font-semibold">会话管理</h2>
              <button onclick="openNewSession()" title="新建会话" class="rounded-lg bg-blue-700 text-white px-2.5 py-1.5 hover:bg-blue-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
              </button>
            </div>
            <div class="mt-2 flex items-center gap-2">
              <button id="multiBtn" onclick="toggleMultiSelect()" class="text-xs rounded-lg border border-slate-300 px-2 py-1 hover:bg-slate-100">多选</button>
              <button id="selectAllBtn" onclick="toggleSelectAllSessions()" class="hidden text-xs rounded-lg border border-slate-300 px-2 py-1 hover:bg-slate-100">全选</button>
              <button id="deleteSelectedBtn" onclick="deleteSelectedSessions()" class="hidden text-xs rounded-lg bg-rose-600 text-white px-2 py-1 hover:bg-rose-700">删除选中</button>
              <span id="selectedCount" class="hidden text-xs text-slate-500"></span>
            </div>
          </div>
          <div id="sessionList" class="flex-1 min-h-0 overflow-y-auto scroll-thin"></div>
        </aside>

        <section class="h-full rounded-2xl border border-slate-200 bg-white/95 shadow-sm flex flex-col overflow-hidden min-h-0">
          <div class="px-3 sm:px-4 py-3 border-b border-slate-200 bg-slate-50/60">
            <div class="flex items-center gap-2">
              <button onclick="toggleMobileSidebar()" title="会话列表" class="lg:hidden rounded-lg border border-slate-300 bg-white px-2.5 py-1.5 text-xs text-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
              </button>
              <div id="chatHeader" class="text-sm text-slate-700 truncate">请选择或新建会话</div>
            </div>
          </div>

          <div id="messages" class="flex-1 min-h-0 overflow-y-auto scroll-thin p-3 sm:p-4 bg-[linear-gradient(180deg,#f8fbff_0%,#f4f8fb_100%)] space-y-3"></div>

          <div id="approvalBar" class="hidden border-t border-amber-200 bg-amber-50 px-4 py-3">
            <div class="text-sm">
              <span class="font-semibold text-amber-800">工具调用待确认：</span>
              <span id="approvalText" class="text-amber-900"></span>
            </div>
            <div class="mt-2 flex gap-2">
              <button id="approvalYesBtn" onclick="respondApproval(true)" class="rounded-lg bg-emerald-600 text-white px-3 py-1.5 text-sm hover:bg-emerald-700">同意执行</button>
              <button id="approvalNoBtn" onclick="respondApproval(false)" class="rounded-lg bg-rose-600 text-white px-3 py-1.5 text-sm hover:bg-rose-700">拒绝</button>
            </div>
          </div>

          <div class="p-3 border-t border-slate-200 bg-white pb-[max(12px,env(safe-area-inset-bottom))]">
            <div class="flex gap-2">
              <textarea id="input" rows="2" class="flex-1 rounded-xl border border-slate-300 px-3 py-2.5 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 resize-none" placeholder="输入消息... Shift+Enter 换行，Enter 发送"></textarea>
              <button onclick="sendMessage()" title="发送" class="self-end rounded-xl bg-blue-700 text-white px-3 py-2.5 hover:bg-blue-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 10l18-7-7 18-2-8-9-3z" />
                </svg>
              </button>
            </div>
          </div>
        </section>
      </div>
    </div>

    <div id="newSessionModal" class="hidden fixed inset-0 bg-black/45 p-4 flex items-center justify-center">
      <div class="w-full max-w-md rounded-2xl bg-white border border-slate-200 p-4 shadow-xl">
        <h3 class="font-semibold">新建会话</h3>
        <p class="text-sm text-slate-500 mt-1">请选择交易对配置</p>
        <select id="configSelect" class="mt-3 w-full rounded-xl border border-slate-300 px-3 py-2.5"></select>
        <input id="sessionTitle" class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2.5" placeholder="会话标题（可选）" />
        <div class="mt-3 flex justify-end gap-2">
          <button onclick="closeNewSession()" class="rounded-lg border border-slate-300 px-3 py-1.5">取消</button>
          <button onclick="createSession()" class="rounded-lg bg-blue-700 text-white px-3 py-1.5">创建</button>
        </div>
      </div>
    </div>

    <script>
      let currentSessionId = null;
      let sessions = [];
      let configs = [];
      let pendingApproval = null;
      let currentMessages = [];
      let multiSelectMode = false;
      let selectedSessionIds = new Set();
      let mobileSidebarOpen = false;
      let approvalLoading = false;

      const mdEscapeHtml = (str) => String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

      const markdownitFactory = window.markdownit;
      const md = (typeof markdownitFactory === 'function')
        ? markdownitFactory({
            html: false,
            linkify: true,
            typographer: true,
            highlight: function (str, lang) {
              if (lang && window.hljs && hljs.getLanguage(lang)) {
                try {
                  return '<pre class="hljs"><code>' +
                         hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                         '</code></pre>';
                } catch (__) {}
              }
              return '<pre class="hljs"><code>' + mdEscapeHtml(str) + '</code></pre>';
            }
          })
        : null;

      function renderMarkdown(content) {
        if (!md) {
          return mdEscapeHtml(content).replace(/\n/g, '<br>');
        }
        return DOMPurify.sanitize(md.render(content));
      }

      function toggleMobileSidebar() {
        mobileSidebarOpen ? closeMobileSidebar() : openMobileSidebar();
      }

      function openMobileSidebar() {
        mobileSidebarOpen = true;
        const sidebar = document.getElementById('sessionSidebar');
        const overlay = document.getElementById('mobileOverlay');
        if (sidebar) sidebar.classList.remove('-translate-x-[110%]');
        if (overlay) overlay.classList.remove('hidden');
      }

      function closeMobileSidebar() {
        mobileSidebarOpen = false;
        const sidebar = document.getElementById('sessionSidebar');
        const overlay = document.getElementById('mobileOverlay');
        if (sidebar) sidebar.classList.add('-translate-x-[110%]');
        if (overlay) overlay.classList.add('hidden');
      }

      function setApprovalLoading(loading) {
        approvalLoading = loading;
        const yesBtn = document.getElementById('approvalYesBtn');
        const noBtn = document.getElementById('approvalNoBtn');
        [yesBtn, noBtn].forEach((btn) => {
          if (!btn) return;
          btn.disabled = loading;
          btn.classList.toggle('opacity-50', loading);
          btn.classList.toggle('cursor-not-allowed', loading);
        });
      }

      function getSessionIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('sid');
      }

      function setSessionIdInUrl(sessionId) {
        const url = new URL(window.location.href);
        if (sessionId) {
          url.searchParams.set('sid', sessionId);
        } else {
          url.searchParams.delete('sid');
        }
        window.history.replaceState({}, '', `${url.pathname}${url.search}`);
      }

      document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('input');
        if (input) {
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage();
            }
          });
        }
      });

      async function login() {
        const password = document.getElementById('password').value;
        const res = await fetch('/api/chat/auth', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({password})
        });
        const data = await res.json();
        if (!data.success) {
          document.getElementById('authErr').textContent = data.message || '认证失败';
          return;
        }
        document.getElementById('authView').style.display = 'none';
        document.getElementById('chatView').style.display = 'block';
        await bootstrap();
      }

      async function bootstrap() {
        const res = await fetch('/api/chat/bootstrap');
        const data = await res.json();
        if (!data.success) return;
        sessions = data.sessions || [];
        configs = data.configs || [];
        if (currentSessionId && !sessions.some(s => s.session_id === currentSessionId)) {
          currentSessionId = null;
          currentMessages = [];
          setSessionIdInUrl(null);
        }
        renderSessions();

        if (!currentSessionId) {
          const sidFromUrl = getSessionIdFromUrl();
          if (sidFromUrl && sessions.some(s => s.session_id === sidFromUrl)) {
            await selectSession(sidFromUrl, { skipUrlSync: true });
          }
        }
      }

      function toggleMultiSelect() {
        multiSelectMode = !multiSelectMode;
        if (!multiSelectMode) selectedSessionIds.clear();
        renderSessions();
      }

      function toggleSelectAllSessions() {
        if (!sessions.length) return;
        if (selectedSessionIds.size === sessions.length) {
          selectedSessionIds.clear();
        } else {
          selectedSessionIds = new Set(sessions.map(s => s.session_id));
        }
        renderSessions();
      }

      function toggleSelected(sessionId, checked) {
        if (checked) selectedSessionIds.add(sessionId);
        else selectedSessionIds.delete(sessionId);
        updateSelectionMeta();
      }

      function updateSelectionMeta() {
        const delBtn = document.getElementById('deleteSelectedBtn');
        const allBtn = document.getElementById('selectAllBtn');
        const count = document.getElementById('selectedCount');
        if (!multiSelectMode) {
          delBtn.classList.add('hidden');
          allBtn.classList.add('hidden');
          count.classList.add('hidden');
          return;
        }
        delBtn.classList.remove('hidden');
        allBtn.classList.remove('hidden');
        allBtn.textContent = selectedSessionIds.size === sessions.length && sessions.length > 0 ? '取消全选' : '全选';
        count.classList.remove('hidden');
        count.textContent = `已选 ${selectedSessionIds.size}`;
      }

      function renderSessions() {
        const list = document.getElementById('sessionList');
        const multiBtn = document.getElementById('multiBtn');
        multiBtn.textContent = multiSelectMode ? '退出多选' : '多选';
        multiBtn.className = multiSelectMode
          ? 'text-xs rounded-lg border border-blue-600 text-blue-700 px-2 py-1 bg-blue-50'
          : 'text-xs rounded-lg border border-slate-300 px-2 py-1 hover:bg-slate-100';
        updateSelectionMeta();

        if (!sessions.length) {
          list.innerHTML = '<div class="p-4 text-sm text-slate-500">暂无会话</div>';
          return;
        }

        list.innerHTML = sessions.map(s => {
          const active = s.session_id === currentSessionId;
          const selected = selectedSessionIds.has(s.session_id);
          return `
            <div class="group border-b border-slate-100 ${active ? 'bg-blue-50/70' : 'hover:bg-slate-50'}">
              <div class="p-3 flex items-start gap-2">
                ${multiSelectMode ? `<input type="checkbox" ${selected ? 'checked' : ''} onchange="toggleSelected('${s.session_id}', this.checked)" class="mt-1 h-4 w-4" />` : ''}
                <button onclick="selectSession('${s.session_id}')" class="flex-1 text-left min-w-0">
                  <div class="font-medium text-sm truncate">${escapeHtml(s.title || s.symbol)}</div>
                  <div class="text-xs text-slate-500 mt-1 truncate">${escapeHtml(s.symbol)} · ${escapeHtml(s.config_id)}</div>
                </button>
                <button onclick="deleteOneSession('${s.session_id}')" class="opacity-0 group-hover:opacity-100 transition text-xs rounded-md border border-rose-200 text-rose-600 px-2 py-1 hover:bg-rose-50">删</button>
              </div>
            </div>
          `;
        }).join('');
      }

      async function selectSession(sessionId, options = {}) {
        if (multiSelectMode) return;
        currentSessionId = sessionId;
        if (!options.skipUrlSync) {
          setSessionIdInUrl(sessionId);
        }
        closeMobileSidebar();
        pendingApproval = null;
        showApproval();
        renderSessions();

        const res = await fetch(`/api/chat/sessions/${sessionId}/messages`);
        const data = await res.json();
        if (!data.success) return;
        document.getElementById('chatHeader').textContent = `${data.session.title} (${data.session.symbol} / ${data.session.config_id})`;
        currentMessages = data.messages || [];
        renderMessages(currentMessages);
      }

      function renderMessages(messages) {
        const container = document.getElementById('messages');
        container.innerHTML = '';

        if (!messages.length) {
          container.innerHTML = '<div class="text-center text-sm text-slate-400 mt-8">暂无消息，开始对话吧</div>';
          return;
        }

        messages.forEach(m => {
          const isUser = m.role === 'user';
          const isTool = m.role === 'tool';
          const bubbleClass = isUser
            ? 'bubble-user ml-auto mobile-bubble-max sm:max-w-[82%]'
            : (isTool ? 'bubble-tool mobile-bubble-max sm:max-w-[90%]' : 'bubble-ai mobile-bubble-max sm:max-w-[90%]');
          const roleText = isUser ? '你' : (isTool ? 'Tool' : 'Agent');
          const el = document.createElement('div');
          el.className = `rounded-2xl px-3 py-2.5 text-sm break-words shadow-[0_1px_2px_rgba(15,23,42,0.04)] ${bubbleClass}`;
          
          let contentHtml;
          const hasToolCalls = Array.isArray(m.tool_calls) && m.tool_calls.length > 0;
          if (m.content) {
              if (isUser) {
                  contentHtml = escapeHtml(m.content);
              } else {
                  contentHtml = renderMarkdown(m.content);
              }
          } else if (m.__streaming) {
              contentHtml = '<div class="flex items-center gap-1"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>';
          } else if (hasToolCalls) {
              const toolBlocks = m.tool_calls.map(tc => {
                const name = escapeHtml(tc.name || 'unknown_tool');
                const args = escapeHtml(JSON.stringify(tc.args || {}, null, 2));
                return `<div class="mb-2"><div class="text-xs font-semibold text-slate-600">调用工具: ${name}</div><pre class="mt-1 tool-args"><code>${args}</code></pre></div>`;
              }).join('');
              contentHtml = `<div class="text-xs text-slate-500 mb-1">模型发起了工具调用，等待执行结果：</div>${toolBlocks}`;
          } else {
              contentHtml = '<span class="text-slate-400 text-xs">[空响应]</span>';
          }
          
          el.innerHTML = `<div class="text-[11px] opacity-70 mb-1">${roleText}</div><div class="prose prose-sm max-w-none">${contentHtml}</div>`;
          container.appendChild(el);
        });

        // Add copy buttons to new code blocks
        container.querySelectorAll('pre').forEach(pre => {
          if (pre.querySelector('.copy-btn')) return; // a lready has a button
          const code = pre.querySelector('code');
          if (!code) return;

          const btn = document.createElement('button');
          btn.textContent = 'Copy';
          btn.className = 'copy-btn';
          btn.onclick = () => {
            navigator.clipboard.writeText(code.textContent).then(() => {
              btn.textContent = 'Copied!';
              setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
            });
          };
          pre.appendChild(btn);
        });

        container.scrollTop = container.scrollHeight;
      }

      async function sendMessage() {
        if (!currentSessionId || pendingApproval) return;
        const input = document.getElementById('input');
        const message = input.value.trim();
        if (!message) return;
        input.value = '';
        input.disabled = true;

        currentMessages.push({ role: 'user', content: message });
        currentMessages.push({ role: 'assistant', content: '', __streaming: true });
        const streamAssistantIndex = currentMessages.length - 1;
        renderMessages(currentMessages);

        const eventSource = new EventSource(`/api/chat/sessions/${currentSessionId}/stream?message=${encodeURIComponent(message)}`);
        let streamClosed = false;

        eventSource.onmessage = function(event) {
          const payload = JSON.parse(event.data);

          if (payload.type === 'token') {
            currentMessages[streamAssistantIndex].content += payload.token || '';
            renderMessages(currentMessages);
          } else if (payload.type === 'done') {
            currentMessages = payload.messages || currentMessages;
            currentMessages = currentMessages.map(m => {
              if (m && m.__streaming) {
                const copy = { ...m };
                delete copy.__streaming;
                return copy;
              }
              return m;
            });
            pendingApproval = payload.pending_approval || null;
            renderMessages(currentMessages);
            showApproval();
            streamClosed = true;
            eventSource.close();
            input.disabled = false;
            input.focus();
            bootstrap(); // Refresh session list to show updated timestamp
          } else if (payload.type === 'error') {
            streamClosed = true;
            if (currentMessages[streamAssistantIndex] && currentMessages[streamAssistantIndex].__streaming) {
              currentMessages[streamAssistantIndex].__streaming = false;
              currentMessages[streamAssistantIndex].content = currentMessages[streamAssistantIndex].content || '[流式失败]';
              renderMessages(currentMessages);
            }
            alert(payload.message || '流式传输失败');
            eventSource.close();
            input.disabled = false;
          }
        };

        eventSource.onerror = function() {
          if (streamClosed) return;
          if (currentMessages[streamAssistantIndex] && currentMessages[streamAssistantIndex].__streaming) {
            currentMessages[streamAssistantIndex].__streaming = false;
            currentMessages[streamAssistantIndex].content = currentMessages[streamAssistantIndex].content || '[连接中断]';
            renderMessages(currentMessages);
          }
          alert('与服务器的连接丢失。');
          eventSource.close();
          input.disabled = false;
        };
      }

      async function respondApproval(approved) {
        if (!currentSessionId || !pendingApproval || approvalLoading) return;
        setApprovalLoading(true);

        currentMessages.push({ role: 'assistant', content: '', __streaming: true });
        const streamAssistantIndex = currentMessages.length - 1;
        renderMessages(currentMessages);

        const eventSource = new EventSource(`/api/chat/sessions/${currentSessionId}/stream?approval=${approved ? 'true' : 'false'}`);
        let streamClosed = false;

        eventSource.onmessage = function(event) {
          const payload = JSON.parse(event.data);
          if (payload.type === 'token') {
            currentMessages[streamAssistantIndex].content += payload.token || '';
            renderMessages(currentMessages);
          } else if (payload.type === 'done') {
            currentMessages = payload.messages || currentMessages;
            pendingApproval = payload.pending_approval || null;
            renderMessages(currentMessages);
            showApproval();
            streamClosed = true;
            setApprovalLoading(false);
            eventSource.close();
            bootstrap();
          } else if (payload.type === 'error') {
            streamClosed = true;
            if (currentMessages[streamAssistantIndex] && currentMessages[streamAssistantIndex].__streaming) {
              currentMessages[streamAssistantIndex].__streaming = false;
              currentMessages[streamAssistantIndex].content = currentMessages[streamAssistantIndex].content || '[审批流式失败]';
              renderMessages(currentMessages);
            }
            setApprovalLoading(false);
            alert(payload.message || '审批失败');
            eventSource.close();
          }
        };

        eventSource.onerror = function() {
          if (streamClosed) return;
          if (currentMessages[streamAssistantIndex] && currentMessages[streamAssistantIndex].__streaming) {
            currentMessages[streamAssistantIndex].__streaming = false;
            currentMessages[streamAssistantIndex].content = currentMessages[streamAssistantIndex].content || '[审批连接中断]';
            renderMessages(currentMessages);
          }
          setApprovalLoading(false);
          alert('与服务器的连接丢失。');
          eventSource.close();
        };
      }

      function showApproval() {
        const bar = document.getElementById('approvalBar');
        const txt = document.getElementById('approvalText');
        if (!pendingApproval || !pendingApproval.value) {
          bar.classList.add('hidden');
          txt.textContent = '';
          setApprovalLoading(false);
          return;
        }
        const v = pendingApproval.value;
        txt.textContent = `${v.tool_name}(${JSON.stringify(v.tool_args)})`;
        bar.classList.remove('hidden');
      }

      async function deleteOneSession(sessionId) {
        if (!confirm('确定删除这个会话吗？')) return;
        const res = await fetch(`/api/chat/sessions/${sessionId}`, { method: 'DELETE' });
        const data = await res.json();
        if (!data.success) {
          alert(data.message || '删除失败');
          return;
        }

        selectedSessionIds.delete(sessionId);
        if (currentSessionId === sessionId) {
          currentSessionId = null;
          currentMessages = [];
          setSessionIdInUrl(null);
          pendingApproval = null;
          showApproval();
          document.getElementById('chatHeader').textContent = '请选择或新建会话';
          renderMessages([]);
        }
        await bootstrap();
      }

      async function deleteSelectedSessions() {
        if (!selectedSessionIds.size) return;
        if (!confirm(`确定删除选中的 ${selectedSessionIds.size} 个会话吗？`)) return;

        const ids = Array.from(selectedSessionIds);
        const res = await fetch('/api/chat/sessions', {
          method: 'DELETE',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ session_ids: ids })
        });
        const data = await res.json();
        if (!data.success) {
          alert(data.message || '批量删除失败');
          return;
        }

        if (currentSessionId && selectedSessionIds.has(currentSessionId)) {
          currentSessionId = null;
          currentMessages = [];
          setSessionIdInUrl(null);
          pendingApproval = null;
          showApproval();
          document.getElementById('chatHeader').textContent = '请选择或新建会话';
          renderMessages([]);
        }
        selectedSessionIds.clear();
        multiSelectMode = false;
        await bootstrap();
      }

      async function openNewSession() {
        if (!configs.length) {
          // Ensure configs are ready even when user clicks quickly after page load.
          await bootstrap();
        }
        const select = document.getElementById('configSelect');
        select.innerHTML = configs.map(c => {
          const configId = (c.config_id || '').trim();
          const labelId = configId || 'MISSING_CONFIG_ID';
          return `<option value="${escapeHtml(configId)}">[${escapeHtml(labelId)}] ${escapeHtml(c.symbol)} · ${escapeHtml(c.mode)}</option>`;
        }).join('');
        document.getElementById('sessionTitle').value = '';
        document.getElementById('newSessionModal').classList.remove('hidden');
      }

      function closeNewSession() {
        document.getElementById('newSessionModal').classList.add('hidden');
      }

      async function createSession() {
        const configId = document.getElementById('configSelect').value;
        const title = document.getElementById('sessionTitle').value.trim();
        const res = await fetch('/api/chat/sessions', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ config_id: configId, title })
        });
        const data = await res.json();
        if (!data.success) {
          alert(data.message || '创建失败');
          return;
        }
        closeNewSession();
        await bootstrap();
        await selectSession(data.session.session_id);
      }

      function escapeHtml(str) {
        return String(str || '').replace(/[&<>"']/g, (s) => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[s]));
      }

      {% if authed %}
      bootstrap();
      {% endif %}
    </script>
  </body>
</html>
