<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat - Crypto Agent</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
    <style>
      /* ä¿®å¤è¾“å…¥æ¡†é«˜åº¦è‡ªé€‚åº”çš„å¹³æ»‘åº¦ */
      #input {
        transition: height 0.1s ease-out;
        overflow-y: hidden; /* é»˜è®¤éšè—æ»šåŠ¨æ¡ */
      }
      #input:focus {
        overflow-y: auto; /* è·å–ç„¦ç‚¹æˆ–å†…å®¹å¤šæ—¶å…è®¸æ»šåŠ¨ */
      }
      /* è¾“å…¥çŠ¶æ€åŠ¨ç”» */
      .typing-dot {
        width: 4px;
        height: 4px;
        background: currentColor;
        border-radius: 50%;
        display: inline-block;
        animation: typing 1.4s infinite both;
        opacity: 0.4;
      }
      .typing-dot:nth-child(2) { animation-delay: 0.2s; }
      .typing-dot:nth-child(3) { animation-delay: 0.4s; }
      @keyframes typing {
        0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
        40% { transform: scale(1.2); opacity: 1; }
      }
      /* å·¥å…·è°ƒç”¨å‚æ•°åˆ—è¡¨æ ·å¼ */
      .tool-arg-row {
        display: grid;
        grid-template-columns: minmax(60px, auto) 1fr;
        gap: 8px;
        padding: 4px 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
      }
      .tool-arg-row:last-child { border-bottom: none; }
      .tool-arg-key { font-weight: 700; color: #64748b; }
      .tool-arg-val { word-break: break-all; color: #1e293b; }
    </style>
  </head>
  <body class="h-screen overflow-hidden bg-slate-50">
    <div id="authView" class="h-screen flex items-center justify-center px-4" {% if authed %}style="display:none"{% endif %}>
      <div class="w-full max-w-sm rounded-3xl border border-slate-200 bg-white/80 backdrop-blur-xl p-8 shadow-2xl">
        <div class="flex justify-center mb-6 text-4xl">ğŸ’¸</div>
        <h1 class="text-2xl font-bold tracking-tight text-center text-slate-900">èº«ä»½éªŒè¯</h1>
        <p class="mt-2 text-sm text-slate-500 text-center">è®¿é—®èŠå¤©åŠŸèƒ½éœ€è¦ç®¡ç†å‘˜æƒé™</p>
        <input id="password" type="password" class="mt-6 w-full rounded-2xl border border-slate-200 bg-slate-50/50 px-4 py-3 outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all text-center font-mono" placeholder="ç®¡ç†å¯†ç " />
        
        <!-- å›¾å½¢éªŒè¯ç åŒºå— -->
        <div class="mt-4 flex gap-2 h-12">
          <div class="flex-1 bg-slate-50/50 rounded-2xl border border-slate-200 overflow-hidden cursor-pointer active:opacity-70 transition-opacity" onclick="refreshCaptcha()" title="ç‚¹å‡»åˆ·æ–°">
            <img id="captcha-img" class="w-full h-full object-cover" alt="éªŒè¯ç ">
          </div>
          <input id="captcha" type="text" class="w-24 rounded-2xl border border-slate-200 bg-slate-50/50 px-2 outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all text-center font-bold uppercase" placeholder="éªŒè¯ç " />
        </div>

        <button onclick="login()" class="mt-4 w-full rounded-2xl bg-blue-600 text-white py-3.5 font-bold hover:bg-blue-700 active:scale-[0.98] transition-all shadow-lg shadow-blue-500/25">ç™»å½•</button>
        <p id="authErr" class="mt-3 text-xs text-rose-500 text-center font-medium"></p>
      </div>
    </div>

    <div id="chatView" class="h-[100dvh] flex flex-col p-0 md:p-3" {% if not authed %}style="display:none"{% endif %}>
      <div id="mobileOverlay" onclick="closeMobileSidebar()" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-30 lg:hidden transition-all"></div>
      
      <div class="relative flex-1 min-h-0 lg:grid lg:grid-cols-[280px_1fr] xl:grid-cols-[320px_1fr] gap-4">
        <aside id="sessionSidebar" class="fixed z-40 inset-y-0 left-0 w-[80vw] max-w-[300px] -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-out lg:static lg:w-auto rounded-none lg:rounded-3xl border-r lg:border border-slate-200 bg-white/90 backdrop-blur-xl shadow-2xl lg:shadow-sm overflow-hidden flex flex-col">
          <div class="p-4 md:p-5 border-b border-slate-100">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-base md:text-lg font-bold text-slate-900 tracking-tight">ä¼šè¯è®°å½•</h2>
              <button onclick="openNewSession(event)" class="group rounded-xl bg-slate-900 text-white p-2 hover:bg-blue-600 transition-all active:scale-90 shadow-lg shadow-slate-900/10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-5 md:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
              </button>
            </div>
            <div class="flex items-center gap-1.5 overflow-x-auto no-scrollbar pb-1">
              <button id="multiBtn" onclick="toggleMultiSelect()" class="text-[9px] md:text-[11px] font-bold uppercase tracking-wider rounded-lg border border-slate-200 px-2 md:px-3 py-1.5 hover:bg-slate-50 transition-colors whitespace-nowrap text-slate-500">æ‰¹é‡ç®¡ç†</button>
              <button id="selectAllBtn" onclick="toggleSelectAllSessions()" class="hidden text-[9px] md:text-[11px] font-bold uppercase tracking-wider rounded-lg border border-slate-200 px-2 md:px-3 py-1.5 hover:bg-slate-50 transition-colors whitespace-nowrap">å…¨é€‰</button>
              <button id="deleteSelectedBtn" onclick="deleteSelectedSessions()" class="hidden text-[9px] md:text-[11px] font-bold uppercase tracking-wider rounded-lg bg-rose-50 text-rose-600 px-2 md:px-3 py-1.5 hover:bg-rose-100 transition-colors whitespace-nowrap">åˆ é™¤é€‰ä¸­</button>
            </div>
          </div>
          <div id="sessionList" class="flex-1 min-h-0 overflow-y-auto mini-scroll py-2 px-2"></div>
        </aside>

        <section class="flex flex-col h-full bg-white lg:rounded-3xl lg:border border-slate-200 shadow-sm overflow-hidden relative">
          <header class="px-3 py-3 md:px-4 md:py-4 border-b border-slate-100 bg-white/50 backdrop-blur-md flex items-center justify-between gap-3 shrink-0">
            <div class="flex items-center gap-2 md:gap-3 min-w-0">
                <button onclick="toggleMobileSidebar()" class="lg:hidden p-2 rounded-xl hover:bg-slate-100 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <div class="min-w-0">
                  <div id="chatHeader" class="text-xs md:text-sm font-bold text-slate-900 truncate tracking-tight uppercase">å½“å‰å¯¹è¯</div>
                  <div id="chatSubHeader" class="text-[9px] md:text-[10px] text-slate-400 font-mono mt-0.5 truncate uppercase tracking-widest">Crypto Agent V0.3</div>
                </div>
            </div>
            <a href="/" class="flex items-center gap-1.5 md:gap-2 px-3 md:px-4 py-1.5 md:py-2 rounded-full bg-slate-100 hover:bg-blue-600 text-slate-600 hover:text-white font-bold text-[10px] md:text-xs transition-all shadow-sm active:scale-95">
                <svg class="w-3.5 h-3.5 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span class="hidden sm:inline">è¿”å›æ§åˆ¶å°</span>
                <span class="sm:hidden text-lg">ğŸ </span>
            </a>
          </header>

          <div id="messages" class="flex-1 overflow-y-auto scroll-thin p-3 md:p-4 space-y-4 md:space-y-6 bg-slate-50/30"></div>
          
          <button id="jumpToBottomBtn" onclick="scrollToBottomAndFollow()" class="hidden absolute right-4 md:right-6 bottom-28 md:bottom-32 z-20 rounded-full bg-slate-900 text-white p-2.5 md:p-3 shadow-2xl hover:scale-110 active:scale-95 transition-all">
            <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7-7-7m14-8l-7 7-7-7"></path></svg>
          </button>

          <div id="approvalBar" class="hidden mx-3 md:mx-4 mb-2 rounded-2xl border border-amber-200 bg-amber-50/80 backdrop-blur-md p-3 md:p-4 shadow-lg animate-in slide-in-from-bottom-4">
            <div class="flex items-start gap-2 md:gap-3">
              <div class="bg-amber-100 p-1.5 md:p-2 rounded-xl text-amber-600 shadow-sm">
                <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-[9px] md:text-[11px] font-bold text-amber-800 uppercase tracking-widest mb-1">ç­‰å¾…æ“ä½œç¡®è®¤</div>
                <div id="approvalText" class="text-[11px] md:text-xs text-amber-900 font-medium leading-relaxed truncate md:whitespace-normal"></div>
                <div class="mt-2 md:mt-3 flex gap-2">
                  <button id="approvalYesBtn" onclick="respondApproval(true)" class="flex-1 bg-emerald-600 text-white py-1.5 md:py-2 rounded-xl text-[10px] md:text-xs font-bold hover:bg-emerald-700 active:scale-95 transition-all shadow-sm">ç¡®è®¤</button>
                  <button id="approvalNoBtn" onclick="respondApproval(false)" class="flex-1 bg-white border border-amber-200 text-amber-700 py-1.5 md:py-2 rounded-xl text-[10px] md:text-xs font-bold hover:bg-amber-50 active:scale-95 transition-all">æ‹’ç»</button>
                </div>
              </div>
            </div>
          </div>

          <div id="composerBar" class="p-3 md:p-4 bg-white shrink-0">
            <div class="relative flex items-end gap-1.5 md:gap-2 bg-slate-100 p-1.5 md:p-2 rounded-[20px] md:rounded-[24px] focus-within:bg-white focus-within:ring-4 focus-within:ring-blue-500/10 transition-all border border-transparent focus-within:border-slate-200">
              <textarea id="input" rows="1" class="flex-1 bg-transparent px-2 md:px-3 py-1.5 md:py-2 outline-none text-xs md:text-sm text-slate-700 placeholder:text-slate-400 resize-none min-h-[36px] max-h-[160px] md:max-h-[200px]" placeholder="æé—®æˆ–æŒ‡ä»¤... (Enterå‘é€)"></textarea>
              <button onclick="sendMessage()" class="group bg-blue-600 text-white p-2 md:p-2.5 rounded-xl md:rounded-2xl hover:bg-blue-700 active:scale-90 transition-all shadow-lg shadow-blue-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-5 md:w-5 transform group-hover:rotate-12 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10l18-7-7 18-2-8-9-3z" /></svg>
              </button>
            </div>
          </div>
        </section>
      </div>
    </div>
        </section>
      </div>
    </div>

    <!-- åˆ›å»ºæ–°ä¼šè¯ Modal -->
    <div id="newSessionModal" class="hidden fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm p-4 flex items-center justify-center animate-in fade-in duration-200">
      <div class="w-full max-w-sm rounded-3xl bg-white border border-slate-200 p-6 shadow-2xl scale-in-center">
        <div class="flex items-center gap-3 mb-4">
            <div class="bg-blue-100 p-2 rounded-xl text-blue-600 shadow-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
            </div>
            <h3 class="text-lg font-bold text-slate-900">åˆ›å»ºæ–°ä¼šè¯</h3>
        </div>
        <p class="text-xs text-slate-500 mb-4 leading-relaxed text-balance">åˆ›å»ºä¸€ä¸ªæ–°çš„èŠå¤©ä¼šè¯ï¼Œä½ å¯ä»¥é€‰æ‹©ä¸åŒçš„ Agent é…ç½®æ¥å¼€å§‹å¯¹è¯ã€‚</p>
        
        <div class="space-y-4">
            <div>
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1">é€‰æ‹© Agent é…ç½®</label>
                <select id="configSelect" class="w-full rounded-2xl border border-slate-200 bg-slate-50/50 px-4 py-3 text-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all"></select>
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1">ä¼šè¯æ ‡é¢˜ (å¯é€‰)</label>
                <input id="sessionTitle" class="w-full rounded-2xl border border-slate-200 bg-slate-50/50 px-4 py-3 text-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all" placeholder="ä¾‹å¦‚ï¼šBTC ç­–ç•¥è®¨è®º" />
            </div>
        </div>

        <div class="mt-8 flex gap-3">
          <button onclick="closeNewSession()" class="flex-1 rounded-2xl border border-slate-200 py-3 text-sm font-bold text-slate-500 hover:bg-slate-50 transition-all">å–æ¶ˆ</button>
          <button onclick="createSession()" class="flex-1 rounded-2xl bg-blue-600 py-3 text-sm font-bold text-white hover:bg-blue-700 shadow-lg shadow-blue-500/25 transition-all active:scale-95">ç«‹å³åˆ›å»º</button>
        </div>
      </div>
    </div>

    <script>
      let currentSessionId = null;
      let sessions = [];
      let configs = [];
      let pendingApproval = null;
      let currentMessages = [];
      let multiSelectMode = false;
      let selectedSessionIds = new Set();
      let mobileSidebarOpen = false;
      let approvalLoading = false;
      let autoScrollEnabled = true;
      const AUTO_SCROLL_THRESHOLD = 56;

      // è¾“å…¥æ¡†è‡ªé€‚åº”é«˜åº¦ä¸å¿«æ·é”®
      const inputEl = document.getElementById('input');
      if (inputEl) {
        inputEl.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });
        inputEl.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }

      function renderMarkdown(content) {
        if (!window.marked) return String(content || '');
        try {
          return DOMPurify.sanitize(marked.parse(String(content || '')));
        } catch (e) {
          return String(content || '');
        }
      }

      function ensureMessagesScrollListener() {
        const container = document.getElementById('messages');
        if (!container || container._scrollListenerInitialized) return container;
        container._scrollListenerInitialized = true;
        container.addEventListener('scroll', () => {
          autoScrollEnabled = (container.scrollHeight - container.scrollTop - container.clientHeight) <= AUTO_SCROLL_THRESHOLD;
          const btn = document.getElementById('jumpToBottomBtn');
          if (btn) btn.classList.toggle('hidden', autoScrollEnabled);
        });
        return container;
      }

      function scrollToBottomAndFollow() {
        const container = document.getElementById('messages');
        if (!container) return;
        autoScrollEnabled = true;
        container.scrollTop = container.scrollHeight;
      }

      function toggleMobileSidebar() {
        mobileSidebarOpen = !mobileSidebarOpen;
        const sidebar = document.getElementById('sessionSidebar');
        const overlay = document.getElementById('mobileOverlay');
        if (sidebar) sidebar.classList.toggle('-translate-x-full', !mobileSidebarOpen);
        if (overlay) overlay.classList.toggle('hidden', !mobileSidebarOpen);
      }

      function closeMobileSidebar() {
        mobileSidebarOpen = false;
        const sidebar = document.getElementById('sessionSidebar');
        const overlay = document.getElementById('mobileOverlay');
        if (sidebar) sidebar.classList.add('-translate-x-full');
        if (overlay) overlay.classList.add('hidden');
      }

      function setApprovalLoading(loading) {
        approvalLoading = loading;
        const yesBtn = document.getElementById('approvalYesBtn');
        const noBtn = document.getElementById('approvalNoBtn');
        if (yesBtn) yesBtn.disabled = loading;
        if (noBtn) noBtn.disabled = loading;
      }

      async function refreshCaptcha() {
        const img = document.getElementById('captcha-img');
        if (!img) return;
        try {
          const resp = await fetch('/api/chat/captcha');
          const data = await resp.json();
          if (data.success) {
            img.src = data.image;
          }
        } catch (e) {
          console.error('Refresh captcha failed', e);
        }
      }

      async function login() {
        const password = document.getElementById('password').value;
        const captcha = document.getElementById('captcha').value;
        if (!password || !captcha) {
          document.getElementById('authErr').textContent = 'è¯·è¾“å…¥å¯†ç å’ŒéªŒè¯ç ';
          return;
        }
        try {
          const res = await fetch('/api/chat/auth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({password, captcha})
          });
          const data = await res.json();
          if (!data.success) {
            document.getElementById('authErr').textContent = data.message || 'éªŒè¯å¤±è´¥';
            refreshCaptcha();
            return;
          }
          location.reload();
        } catch (e) {
          alert('Network error');
        }
      }

      async function bootstrap() {
        try {
          const res = await fetch('/api/chat/bootstrap');
          if (res.status === 401) {
            document.getElementById('authView').style.display = 'flex';
            document.getElementById('chatView').style.display = 'none';
            return;
          }
          const data = await res.json();
          if (!data.success) return;
          sessions = data.sessions || [];
          configs = data.configs || [];
          renderSessions();
          const sidFromUrl = new URLSearchParams(window.location.search).get('sid');
          if (sidFromUrl && !currentSessionId) selectSession(sidFromUrl, {skipUrlSync: true});
        } catch (e) {
          console.error('Bootstrap failed', e);
        }
      }

      function toggleMultiSelect() {
        multiSelectMode = !multiSelectMode;
        if (!multiSelectMode) selectedSessionIds.clear();
        renderSessions();
      }

      function toggleSelected(sessionId, checked) {
        if (checked) selectedSessionIds.add(sessionId);
        else selectedSessionIds.delete(sessionId);
        const delBtn = document.getElementById('deleteSelectedBtn');
        const allBtn = document.getElementById('selectAllBtn');
        if (delBtn) delBtn.classList.toggle('hidden', !multiSelectMode);
        if (allBtn) allBtn.classList.toggle('hidden', !multiSelectMode);
      }

      function toggleSelectAllSessions() {
        if (selectedSessionIds.size === sessions.length) selectedSessionIds.clear();
        else sessions.forEach(s => selectedSessionIds.add(s.session_id));
        renderSessions();
      }

      function renderSessions() {
        const list = document.getElementById('sessionList');
        const multiBtn = document.getElementById('multiBtn');
        if (!list) return;

        multiBtn.textContent = multiSelectMode ? 'å–æ¶ˆæ‰¹é‡' : 'æ‰¹é‡ç®¡ç†';

        list.innerHTML = sessions.map(s => `
          <div class="group border-b border-slate-50 ${s.session_id === currentSessionId ? 'bg-blue-50/70 shadow-sm rounded-xl' : 'hover:bg-slate-50 rounded-xl transition-all'} m-1">
            <div class="p-3 flex items-start gap-2">
              ${multiSelectMode ? `<input type="checkbox" ${selectedSessionIds.has(s.session_id) ? 'checked' : ''} onchange="toggleSelected('${s.session_id}', this.checked)" class="mt-1 h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" />` : ''}
              <button onclick="selectSession('${s.session_id}')" class="flex-1 text-left min-w-0">
                <div class="font-bold text-sm truncate text-slate-800">${escapeHtml(s.title || s.symbol)}</div>
                <div class="text-[10px] text-slate-400 mt-1 uppercase font-mono">${escapeHtml(s.symbol)} Â· ${escapeHtml(s.config_id)}</div>
              </button>
              ${!multiSelectMode ? `<button onclick="deleteOneSession('${s.session_id}')" class="opacity-0 group-hover:opacity-100 text-[10px] text-rose-400 hover:text-rose-600 p-1 transition-opacity">åˆ é™¤</button>` : ''}
            </div>
          </div>
        `).join('');
      }

      async function selectSession(sessionId, options = {}) {
        if (multiSelectMode) return;
        currentSessionId = sessionId;
        const container = document.getElementById('messages');
        if (container) container.innerHTML = '<div class="h-full flex flex-col items-center justify-center text-slate-400 text-xs animate-pulse space-y-2"><span>åŠ è½½æ¶ˆæ¯ä¸­...</span></div>';

        if (!options.skipUrlSync) {
          const url = new URL(window.location.href);
          url.searchParams.set('sid', sessionId);
          window.history.replaceState({}, '', url.search);
        }
        closeMobileSidebar();
        pendingApproval = null;
        showApproval();
        renderSessions();

        try {
          const res = await fetch(`/api/chat/sessions/${sessionId}/messages`);
          const data = await res.json();
          if (data.success) {
            const header = document.getElementById('chatHeader');
            if (header && data.session) header.textContent = data.session.title;
            currentMessages = normalizeMessages(data.messages || []);
            renderMessages(currentMessages);
          }
        } catch (e) {
          if (container) container.innerHTML = '<div class="text-rose-500 p-4 text-center">åŠ è½½å¤±è´¥</div>';
        }
      }

      function normalizeOneMessage(m) {
        const msg = { ...(m || {}) };
        if (msg.content == null) msg.content = '';
        msg.content = String(msg.content);
        if (msg.reasoning_content == null) msg.reasoning_content = '';
        msg.reasoning_content = String(msg.reasoning_content || '');

        const matched = msg.content.match(/<thinking>([\s\S]*?)<\/thinking>/i);
        if (matched) {
          if (!msg.reasoning_content) msg.reasoning_content = matched[1].trim();
          msg.content = msg.content.replace(/<thinking>[\s\S]*?<\/thinking>\s*/ig, '').trimStart();
        }

        if (msg.__thinking_open == null) {
          msg.__thinking_open = !!(msg.__streaming || msg.__loading || msg.reasoning_content);
        }
        return msg;
      }

      function normalizeMessages(messages) {
        return (messages || []).map(normalizeOneMessage);
      }

      function renderThinkingHtml(message, idx, isStreaming) {
        const reasoning = String(message.reasoning_content || '').trim();
        // å…³é”®ä¿®å¤ï¼šå¦‚æœæ²¡æœ‰æ¨ç†å†…å®¹ï¼Œä¸”ä¸æ˜¯æ­£åœ¨è¿›è¡Œä¸­çš„æ€è€ƒï¼ˆæ²¡æœ‰æ”¶åˆ°è¿‡æ¨ç†ä»¤ç‰Œï¼‰ï¼Œåˆ™ä¸æ¸²æŸ“æ€è€ƒå—
        if (!reasoning) return '';

        const body = isStreaming
          ? `<div class="whitespace-pre-wrap text-[11px] text-slate-500 italic leading-relaxed">${escapeHtml(reasoning)}<span class="animate-pulse">...</span></div>`
          : `<div class="text-[11px] text-slate-500 italic leading-relaxed">${renderMarkdown(reasoning)}</div>`;

        return `
          <details data-thinking-wrap="1" class="mb-3 rounded-xl border border-slate-200 bg-slate-50/50 overflow-hidden" ${message.__thinking_open ? 'open' : ''}>
            <summary onclick="rememberThinkingState(${idx}, this.parentElement.open)" class="px-3 py-2 cursor-pointer list-none select-none text-[10px] font-bold uppercase tracking-widest text-slate-400 flex items-center justify-between">
              <span>æ€è€ƒè¿‡ç¨‹</span>
              <svg class="w-3 h-3 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 9l-7 7-7-7" stroke-width="3"/></svg>
            </summary>
            <div data-thinking-body="1" class="px-3 pb-3 border-t border-slate-100/50">${body}</div>
          </details>`;
      }

      function rememberThinkingState(idx, wasOpen) {
        if (!currentMessages[idx]) return;
        currentMessages[idx].__thinking_open = !wasOpen;
      }

      function renderMessages(messages) {
        const container = ensureMessagesScrollListener();
        if (!container) return;

        const html = messages.map((rawMessage, idx) => {
          const m = normalizeOneMessage(rawMessage);
          messages[idx] = m;

          const hasToolCalls = m.tool_calls && m.tool_calls.length > 0;
          const hasThinking = !!String(m.reasoning_content || '').trim();
          const isStreaming = m.__streaming || m.__loading;

          if (!m.content && !hasToolCalls && !hasThinking && !isStreaming) return '';

          const isUser = m.role === 'user';
          const isTool = m.role === 'tool';
          const animationClass = (isStreaming || idx < messages.length - 1) ? '' : 'animate-in slide-in-from-bottom-2 duration-300';

          if (isTool) {
            return `
              <div id="msg-${idx}" class="flex items-start gap-2 mb-4 max-w-[90%]">
                <div class="flex-1 bg-slate-100 border border-slate-200 rounded-2xl p-3 text-[11px] font-mono text-slate-600 shadow-inner ${animationClass}">
                  <div class="flex items-center gap-2 mb-1.5 opacity-60"><span class="font-bold uppercase tracking-wider">å·¥å…·è¾“å‡º</span></div>
                  <div class="whitespace-pre-wrap">${escapeHtml(m.content)}</div>
                </div>
              </div>`;
          }

          const bubbleClass = isUser
            ? 'ml-auto bg-blue-600 text-white rounded-br-none shadow-md'
            : 'bg-white border border-slate-200 text-slate-800 rounded-bl-none shadow-sm';

          let toolCallsHtml = '';
          if (hasToolCalls) {
            toolCallsHtml = m.tool_calls.map(tc => {
              const args = tc.args || {};
              const argsHtml = Object.entries(args).map(([k, v]) => `
                <div class="tool-arg-row">
                  <span class="tool-arg-key">${escapeHtml(k)}</span>
                  <span class="tool-arg-val">${escapeHtml(typeof v === 'object' ? JSON.stringify(v) : v)}</span>
                </div>
              `).join('');

              return `
                <div class="mt-3 p-4 bg-slate-50 rounded-2xl border border-slate-200 text-[11px]">
                  <div class="flex items-center gap-2 text-blue-600 font-bold mb-3">
                    <div class="bg-blue-600 text-white px-1.5 py-0.5 rounded text-[9px] uppercase">Tool</div>
                    <span>${escapeHtml(tc.name)}</span>
                  </div>
                  <div class="space-y-1">${argsHtml}</div>
                </div>
              `;
            }).join('');
          }

          const bodyHtml = isStreaming
            ? `<div data-msg-body="1" class="md-content whitespace-pre-wrap">${m.content ? escapeHtml(m.content) : '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>'}</div>`
            : `<div data-msg-body="1" class="md-content">${renderMarkdown(m.content)}</div>`;

          return `
            <div id="msg-${idx}" class="flex flex-col gap-1 mb-4 ${isUser ? 'items-end' : 'items-start'}">
              <div class="chat-bubble p-4 rounded-3xl max-w-[92%] sm:max-w-[85%] ${bubbleClass} ${animationClass}">
                ${renderThinkingHtml(m, idx, isStreaming)}
                ${bodyHtml}
                ${toolCallsHtml}
              </div>
            </div>`;
        }).join('');

        container.innerHTML = html;
        if (autoScrollEnabled) scrollToBottomAndFollow();
      }

      function ensureThinkingDom(msgRoot, idx) {
        let wrap = msgRoot.querySelector('[data-thinking-wrap="1"]');
        if (!wrap) {
          const bubble = msgRoot.querySelector('.chat-bubble');
          if (!bubble) return null;

          wrap = document.createElement('details');
          wrap.setAttribute('data-thinking-wrap', '1');
          wrap.className = 'mb-3 rounded-xl border border-slate-200 bg-slate-50/50 overflow-hidden';
          wrap.innerHTML = `
            <summary class="px-3 py-2 cursor-pointer list-none select-none text-[10px] font-bold uppercase tracking-widest text-slate-400 flex items-center justify-between">
              <span>æ€è€ƒè¿‡ç¨‹</span>
              <svg class="w-3 h-3 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 9l-7 7-7-7" stroke-width="3"/></svg>
            </summary>
            <div data-thinking-body="1" class="px-3 pb-3 border-t border-slate-100/50"></div>`;
          const summary = wrap.querySelector('summary');
          summary.onclick = () => rememberThinkingState(idx, wrap.open);
          bubble.insertBefore(wrap, bubble.firstChild);
        }
        return wrap;
      }

      function updateStreamingAssistantMessage(idx) {
        const msg = currentMessages[idx];
        if (!msg) return;

        const msgRoot = document.getElementById(`msg-${idx}`);
        if (!msgRoot) {
          renderMessages(currentMessages);
          return;
        }

        const body = msgRoot.querySelector('[data-msg-body="1"]');
        if (body) body.textContent = msg.content || '';

        const reasoning = String(msg.reasoning_content || '').trim();
        if (reasoning) {
          const wrap = ensureThinkingDom(msgRoot, idx);
          if (wrap) {
            wrap.open = msg.__thinking_open !== false;
            const thinkingBody = wrap.querySelector('[data-thinking-body="1"]');
            if (thinkingBody) thinkingBody.innerHTML = `<div class="whitespace-pre-wrap text-[11px] text-slate-500 italic leading-relaxed">${escapeHtml(reasoning)}${msg.__streaming ? '<span class="animate-pulse">...</span>' : ''}</div>`;
          }
        }

        if (autoScrollEnabled) scrollToBottomAndFollow();
      }

      function appendStreamDelta(streamIdx, delta) {
        const msg = currentMessages[streamIdx];
        if (!msg) return;

        if (delta.reasoning) {
          msg.reasoning_content = (msg.reasoning_content || '') + delta.reasoning;
          if (msg.__thinking_open == null) msg.__thinking_open = true;
        }
        if (delta.content) {
          msg.content = (msg.content || '') + delta.content;
        }
        msg.__streaming = true;

        updateStreamingAssistantMessage(streamIdx);
      }

      async function sendMessage() {
        const input = document.getElementById('input');
        const message = input.value.trim();
        if (!message || !currentSessionId || pendingApproval) return;

        input.value = '';
        input.style.height = '40px';

        const isFirstMessage = currentMessages.length === 0;

        currentMessages.push({ role: 'user', content: message });
        const streamIdx = currentMessages.length;
        currentMessages.push({ role: 'assistant', content: '', reasoning_content: '', __streaming: true, __thinking_open: true });
        renderMessages(currentMessages);

        const eventSource = new EventSource(`/api/chat/sessions/${currentSessionId}/stream?message=${encodeURIComponent(message)}`);
        eventSource.onmessage = (e) => {
          const payload = JSON.parse(e.data);
          if (payload.type === 'token') {
            appendStreamDelta(streamIdx, { content: payload.token || '' });
          } else if (payload.type === 'reasoning_token') {
            appendStreamDelta(streamIdx, { reasoning: payload.token || '' });
          } else if (payload.type === 'done') {
            currentMessages = normalizeMessages(payload.messages || []);
            pendingApproval = payload.pending_approval;
            renderMessages(currentMessages);
            showApproval();
            eventSource.close();

            // è‡ªåŠ¨æ€»ç»“æ ‡é¢˜
            if (isFirstMessage) {
              fetch(`/api/chat/sessions/${currentSessionId}/summarize_title`, {method: 'POST'})
                .then(r => r.json())
                .then(d => { if(d.success) bootstrap(); });
            }
          } else if (payload.type === 'error') {
            alert('Streaming error: ' + payload.message);
            eventSource.close();
          }
        };
        eventSource.onerror = () => eventSource.close();
      }

      async function respondApproval(approved) {
        document.getElementById('approvalBar').classList.add('hidden');
        setApprovalLoading(true);

        const streamIdx = currentMessages.length;
        currentMessages.push({ role: 'assistant', content: 'æ‰§è¡Œä¸­...', reasoning_content: '', __loading: true, __streaming: true, __thinking_open: true });
        renderMessages(currentMessages);

        const eventSource = new EventSource(`/api/chat/sessions/${currentSessionId}/stream?approval=${approved}`);
        eventSource.onmessage = (e) => {
          const payload = JSON.parse(e.data);
          if (payload.type === 'token') {
            if (currentMessages[streamIdx] && currentMessages[streamIdx].__loading) {
              currentMessages[streamIdx].content = '';
              delete currentMessages[streamIdx].__loading;
            }
            appendStreamDelta(streamIdx, { content: payload.token || '' });
          } else if (payload.type === 'reasoning_token') {
            if (currentMessages[streamIdx] && currentMessages[streamIdx].__loading) {
              currentMessages[streamIdx].content = '';
              delete currentMessages[streamIdx].__loading;
            }
            appendStreamDelta(streamIdx, { reasoning: payload.token || '' });
          } else if (payload.type === 'done') {
            currentMessages = normalizeMessages(payload.messages || []);
            pendingApproval = payload.pending_approval;
            renderMessages(currentMessages);
            showApproval();
            setApprovalLoading(false);
            eventSource.close();
          }
        };
        eventSource.onerror = () => { eventSource.close(); setApprovalLoading(false); };
      }

      function showApproval() {
        const bar = document.getElementById('approvalBar');
        if (!pendingApproval || !pendingApproval.value) {
          if (bar) bar.classList.add('hidden');
          return;
        }
        const v = pendingApproval.value;
        const txt = document.getElementById('approvalText');
        if (txt) txt.innerHTML = `<span class="bg-amber-100 text-amber-800 px-1.5 py-0.5 rounded font-mono font-bold mr-2 uppercase text-[10px]">${v.tool_name}</span> <span class="opacity-70">${JSON.stringify(v.tool_args)}</span>`;
        if (bar) bar.classList.remove('hidden');
      }

      async function deleteOneSession(sessionId) {
        if (!confirm('ç¡®å®šåˆ é™¤æ­¤ä¼šè¯?')) return;
        try {
          const res = await fetch(`/api/chat/sessions/${sessionId}`, { method: 'DELETE' });
          const data = await res.json();
          if (data.success) {
            sessions = sessions.filter(s => s.session_id !== sessionId);
            renderSessions();
            if (currentSessionId === sessionId) {
              currentSessionId = null;
              currentMessages = [];
              const msgDiv = document.getElementById('messages');
              if (msgDiv) msgDiv.innerHTML = '';
              const header = document.getElementById('chatHeader');
              if (header) header.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªä¼šè¯';
              setSessionIdInUrl(null);
            }
          }
        } catch (e) {
          alert('åˆ é™¤å¤±è´¥');
        }
      }

      async function deleteSelectedSessions() {
        if (!selectedSessionIds.size || !confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedSessionIds.size} ä¸ªä¼šè¯?`)) return;
        try {
          const res = await fetch('/api/chat/sessions', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ids: Array.from(selectedSessionIds) })
          });
          const data = await res.json();
          if (data.success) location.reload();
        } catch (e) {
          alert('æ‰¹é‡åˆ é™¤å¤±è´¥');
        }
      }

      function openNewSession(e) {
        const modal = document.getElementById('newSessionModal');
        if (!modal) return;

        if (configs.length === 0) {
          // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œå°è¯•åˆ·æ–°ä¸€æ¬¡ï¼Œå¹¶åœ¨å®Œæˆåå†æ¬¡å°è¯•æ‰“å¼€
          const btn = e ? e.currentTarget : null;
          if (btn) btn.disabled = true;
          bootstrap().then(() => {
            if (btn) btn.disabled = false;
            if (configs.length > 0) {
              openNewSession();
            } else {
              alert('æœªå‘ç°å¯ç”¨çš„äº¤æ˜“å¯¹é…ç½®ï¼Œè¯·åœ¨æ§åˆ¶å°æ£€æŸ¥ SYMBOL_CONFIGS æ˜¯å¦é…ç½®æ­£ç¡®ã€‚');
            }
          });
          return;
        }

        const select = document.getElementById('configSelect');
        if (select) {
          select.innerHTML = configs.map(c => {
            const displayName = c.title || `${c.symbol} (${c.model})`;
            return `<option value="${c.config_id}">${escapeHtml(displayName)}</option>`;
          }).join('');
        }
        modal.classList.remove('hidden');
      }

      function closeNewSession() {
        const modal = document.getElementById('newSessionModal');
        if (modal) modal.classList.add('hidden');
      }

      async function createSession() {
        try {
          const res = await fetch('/api/chat/sessions', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              config_id: document.getElementById('configSelect').value,
              title: document.getElementById('sessionTitle').value
            })
          });
          const data = await res.json();
          if (data.success) {
            closeNewSession();
            await bootstrap();
            selectSession(data.session_id);
          }
        } catch (e) {
          alert('åˆ›å»ºå¤±è´¥');
        }
      }

      function escapeHtml(str) {
        return String(str || '').replace(/[&<>"']/g, (s) => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[s]));
      }

      function setSessionIdInUrl(sessionId) {
        const url = new URL(window.location.href);
        if (sessionId) url.searchParams.set('sid', sessionId);
        else url.searchParams.delete('sid');
        window.history.replaceState({}, '', url.search);
      }

      refreshCaptcha();
      bootstrap();
</script>
  </body>
</html>
