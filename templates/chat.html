<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat - Crypto Agent</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
  </head>
  <body class="h-screen overflow-hidden">
    <div id="authView" class="h-screen flex items-center justify-center px-4" {% if authed %}style="display:none"{% endif %}>
      <div class="w-full max-w-sm rounded-2xl border border-slate-200 bg-white/95 p-6 shadow-xl">
        <h1 class="text-xl font-semibold tracking-tight">聊天访问验证</h1>
        <p class="mt-2 text-sm text-slate-500">输入密码后进入会话管理与聊天</p>
        <input id="password" type="password" class="mt-4 w-full rounded-xl border border-slate-300 px-3 py-2.5 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" placeholder="Password" />
        <button onclick="login()" class="mt-3 w-full rounded-xl bg-blue-700 text-white py-2.5 hover:bg-blue-800 transition">进入聊天</button>
        <p id="authErr" class="mt-2 text-sm text-rose-600"></p>
      </div>
    </div>

    <div id="chatView" class="h-[100dvh] p-2 sm:p-4" {% if not authed %}style="display:none"{% endif %}>
      <div id="mobileOverlay" onclick="closeMobileSidebar()" class="hidden fixed inset-0 bg-black/35 z-30 lg:hidden"></div>
      <div class="relative h-full min-w-0 lg:grid lg:grid-cols-[340px_1fr] gap-3 sm:gap-4">
        <aside id="sessionSidebar" class="fixed z-40 inset-y-2 left-2 w-[88vw] max-w-[360px] -translate-x-[110%] transition-transform duration-200 rounded-2xl border border-slate-200 bg-white/95 backdrop-blur shadow-sm overflow-hidden flex flex-col min-h-0 lg:static lg:z-auto lg:inset-auto lg:w-auto lg:max-w-none lg:translate-x-0">
          <div class="p-3 border-b border-slate-200 bg-slate-50/70">
            <div class="flex items-center justify-between gap-2">
              <h2 class="font-semibold">会话管理</h2>
              <button onclick="openNewSession()" title="新建会话" class="rounded-lg bg-blue-700 text-white px-2.5 py-1.5 hover:bg-blue-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
              </button>
            </div>
            <div class="mt-2 flex items-center gap-2">
              <button id="multiBtn" onclick="toggleMultiSelect()" class="text-xs rounded-lg border border-slate-300 px-2 py-1 hover:bg-slate-100">多选</button>
              <button id="selectAllBtn" onclick="toggleSelectAllSessions()" class="hidden text-xs rounded-lg border border-slate-300 px-2 py-1 hover:bg-slate-100">全选</button>
              <button id="deleteSelectedBtn" onclick="deleteSelectedSessions()" class="hidden text-xs rounded-lg bg-rose-600 text-white px-2 py-1 hover:bg-rose-700">删除选中</button>
              <span id="selectedCount" class="hidden text-xs text-slate-500"></span>
            </div>
          </div>
          <div id="sessionList" class="flex-1 min-h-0 overflow-y-auto scroll-thin"></div>
        </aside>

        <section class="h-full rounded-2xl border border-slate-200 bg-white/95 shadow-sm flex flex-col overflow-hidden min-h-0 min-w-0 relative">
          <div class="px-3 sm:px-4 py-3 border-b border-slate-200 bg-slate-50/60">
            <div class="flex items-center gap-2">
              <button onclick="toggleMobileSidebar()" title="会话列表" class="lg:hidden rounded-lg border border-slate-300 bg-white px-2.5 py-1.5 text-xs text-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
              </button>
              <div id="chatHeader" class="text-sm text-slate-700 truncate">请选择或新建会话</div>
            </div>
          </div>

          <div id="messages" class="flex-1 min-h-0 overflow-y-auto scroll-thin p-3 sm:p-4 bg-[linear-gradient(180deg,#f8fbff_0%,#f4f8fb_100%)] space-y-3"></div>
          <button id="jumpToBottomBtn" onclick="scrollToBottomAndFollow()" class="hidden absolute right-4 bottom-24 z-20 rounded-full border border-blue-200 bg-white/95 text-blue-700 px-3 py-1.5 text-xs shadow-sm hover:bg-blue-50">
            回到底部
          </button>

          <div id="approvalBar" class="hidden border-t border-amber-200 bg-amber-50 px-4 py-3">
            <div class="text-sm">
              <span class="font-semibold text-amber-800">工具调用待确认：</span>
              <span id="approvalText" class="text-amber-900"></span>
            </div>
            <div class="mt-2 flex gap-2">
              <button id="approvalYesBtn" onclick="respondApproval(true)" class="rounded-lg bg-emerald-600 text-white px-3 py-1.5 text-sm hover:bg-emerald-700">同意执行</button>
              <button id="approvalNoBtn" onclick="respondApproval(false)" class="rounded-lg bg-rose-600 text-white px-3 py-1.5 text-sm hover:bg-rose-700">拒绝</button>
            </div>
          </div>

          <div id="composerBar" class="p-3 border-t border-slate-200 bg-white">
            <div class="flex gap-2">
              <textarea id="input" rows="1" class="flex-1 rounded-xl border border-slate-300 px-3 py-2 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 resize-none min-h-[44px] max-h-[180px]" placeholder="输入消息..."></textarea>
              <button onclick="sendMessage()" title="发送" class="self-end rounded-xl bg-blue-700 text-white px-3 py-2 hover:bg-blue-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 10l18-7-7 18-2-8-9-3z" />
                </svg>
              </button>
            </div>
          </div>
        </section>
      </div>
    </div>

    <div id="newSessionModal" class="hidden fixed inset-0 bg-black/45 p-4 flex items-center justify-center">
      <div class="w-full max-w-md rounded-2xl bg-white border border-slate-200 p-4 shadow-xl">
        <h3 class="font-semibold">新建会话</h3>
        <p class="text-sm text-slate-500 mt-1">请选择交易对配置</p>
        <select id="configSelect" class="mt-3 w-full rounded-xl border border-slate-300 px-3 py-2.5"></select>
        <input id="sessionTitle" class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2.5" placeholder="会话标题（可选）" />
        <div class="mt-3 flex justify-end gap-2">
          <button onclick="closeNewSession()" class="rounded-lg border border-slate-300 px-3 py-1.5">取消</button>
          <button onclick="createSession()" class="rounded-lg bg-blue-700 text-white px-3 py-1.5">创建</button>
        </div>
      </div>
    </div>

    <script>
      let currentSessionId = null;
      let sessions = [];
      let configs = [];
      let pendingApproval = null;
      let currentMessages = [];
      let multiSelectMode = false;
      let selectedSessionIds = new Set();
      let mobileSidebarOpen = false;
      let approvalLoading = false;
      let streamRenderTimer = null;
      let streamRenderQueue = null;
      let autoScrollEnabled = true;
      const AUTO_SCROLL_THRESHOLD = 56;

      const mdEscapeHtml = (str) => String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

      const markdownitFactory = window.markdownit;
      const md = (typeof markdownitFactory === 'function')
        ? markdownitFactory({
            html: false,
            linkify: true,
            breaks: false,
            typographer: true,
            highlight: function (str, lang) {
              if (lang && window.hljs && hljs.getLanguage(lang)) {
                try {
                  return '<pre class="hljs"><code>' +
                         hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                         '</code></pre>';
                } catch (__) {}
              }
              return '<pre class="hljs"><code>' + mdEscapeHtml(str) + '</code></pre>';
            }
          })
        : null;

      if (md) {
        const defaultLinkOpen = md.renderer.rules.link_open || function(tokens, idx, options, env, self) {
          return self.renderToken(tokens, idx, options);
        };
        md.renderer.rules.link_open = function(tokens, idx, options, env, self) {
          tokens[idx].attrSet('target', '_blank');
          tokens[idx].attrSet('rel', 'noopener noreferrer nofollow');
          return defaultLinkOpen(tokens, idx, options, env, self);
        };
      }

      function renderMarkdown(content) {
        if (!md) {
          return mdEscapeHtml(content).replace(/\n/g, '<br>');
        }
        const html = DOMPurify.sanitize(md.render(content));
        return html
          .replace(/<table>/g, '<div class="md-table-wrap"><table>')
          .replace(/<\/table>/g, '</table></div>');
      }

      function scheduleStreamRender(messages, force = false) {
        if (force) {
          if (streamRenderTimer) {
            clearTimeout(streamRenderTimer);
            streamRenderTimer = null;
          }
          streamRenderQueue = null;
          renderMessages(messages);
          return;
        }

        streamRenderQueue = messages;
        if (streamRenderTimer) return;
        streamRenderTimer = setTimeout(() => {
          streamRenderTimer = null;
          const nextMessages = streamRenderQueue || currentMessages;
          streamRenderQueue = null;
          renderMessages(nextMessages);
        }, 60);
      }

      function isNearBottom(container) {
        if (!container) return true;
        return (container.scrollHeight - container.scrollTop - container.clientHeight) <= AUTO_SCROLL_THRESHOLD;
      }

      function updateJumpToBottomButton() {
        const btn = document.getElementById('jumpToBottomBtn');
        if (!btn) return;
        btn.classList.toggle('hidden', autoScrollEnabled);
      }

      function scrollToBottomAndFollow() {
        const container = ensureMessagesScrollListener();
        if (!container) return;
        autoScrollEnabled = true;
        container.scrollTop = container.scrollHeight;
        updateJumpToBottomButton();
      }

      function ensureMessagesScrollListener() {
        const container = document.getElementById('messages');
        if (!container || container._scrollListenerInitialized) return container;
        container._scrollListenerInitialized = true;
        container.addEventListener('scroll', () => {
          autoScrollEnabled = isNearBottom(container);
          updateJumpToBottomButton();
        });
        return container;
      }

      function toggleMobileSidebar() {
        mobileSidebarOpen ? closeMobileSidebar() : openMobileSidebar();
      }

      function openMobileSidebar() {
        mobileSidebarOpen = true;
        const sidebar = document.getElementById('sessionSidebar');
        const overlay = document.getElementById('mobileOverlay');
        if (sidebar) sidebar.classList.remove('-translate-x-[110%]');
        if (overlay) overlay.classList.remove('hidden');
      }

      function closeMobileSidebar() {
        mobileSidebarOpen = false;
        const sidebar = document.getElementById('sessionSidebar');
        const overlay = document.getElementById('mobileOverlay');
        if (sidebar) sidebar.classList.add('-translate-x-[110%]');
        if (overlay) overlay.classList.add('hidden');
      }

      function setApprovalLoading(loading) {
        approvalLoading = loading;
        const yesBtn = document.getElementById('approvalYesBtn');
        const noBtn = document.getElementById('approvalNoBtn');
        [yesBtn, noBtn].forEach((btn) => {
          if (!btn) return;
          btn.disabled = loading;
          btn.classList.toggle('opacity-50', loading);
          btn.classList.toggle('cursor-not-allowed', loading);
        });
      }

      function getSessionIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('sid');
      }

      function setSessionIdInUrl(sessionId) {
        const url = new URL(window.location.href);
        if (sessionId) {
          url.searchParams.set('sid', sessionId);
        } else {
          url.searchParams.delete('sid');
        }
        window.history.replaceState({}, '', `${url.pathname}${url.search}`);
      }

      document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('input');
        const autoResize = () => {
          if (!input) return;
          input.style.height = 'auto';
          const next = Math.min(input.scrollHeight, 180);
          input.style.height = `${Math.max(40, next)}px`;
        };
        if (input) {
          autoResize();
          input.addEventListener('input', autoResize);
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage();
            }
          });
        }
      });

      async function login() {
        const password = document.getElementById('password').value;
        const res = await fetch('/api/chat/auth', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({password})
        });
        const data = await res.json();
        if (!data.success) {
          document.getElementById('authErr').textContent = data.message || '认证失败';
          return;
        }
        document.getElementById('authView').style.display = 'none';
        document.getElementById('chatView').style.display = 'block';
        await bootstrap();
      }

      async function bootstrap() {
        const res = await fetch('/api/chat/bootstrap');
        const data = await res.json();
        if (!data.success) return;
        sessions = data.sessions || [];
        configs = data.configs || [];
        if (currentSessionId && !sessions.some(s => s.session_id === currentSessionId)) {
          currentSessionId = null;
          currentMessages = [];
          setSessionIdInUrl(null);
        }
        renderSessions();

        if (!currentSessionId) {
          const sidFromUrl = getSessionIdFromUrl();
          if (sidFromUrl && sessions.some(s => s.session_id === sidFromUrl)) {
            await selectSession(sidFromUrl, { skipUrlSync: true });
          }
        }
      }

      function toggleMultiSelect() {
        multiSelectMode = !multiSelectMode;
        if (!multiSelectMode) selectedSessionIds.clear();
        renderSessions();
      }

      function toggleSelectAllSessions() {
        if (!sessions.length) return;
        if (selectedSessionIds.size === sessions.length) {
          selectedSessionIds.clear();
        } else {
          selectedSessionIds = new Set(sessions.map(s => s.session_id));
        }
        renderSessions();
      }

      function toggleSelected(sessionId, checked) {
        if (checked) selectedSessionIds.add(sessionId);
        else selectedSessionIds.delete(sessionId);
        updateSelectionMeta();
      }

      function updateSelectionMeta() {
        const delBtn = document.getElementById('deleteSelectedBtn');
        const allBtn = document.getElementById('selectAllBtn');
        const count = document.getElementById('selectedCount');
        if (!multiSelectMode) {
          delBtn.classList.add('hidden');
          allBtn.classList.add('hidden');
          count.classList.add('hidden');
          return;
        }
        delBtn.classList.remove('hidden');
        allBtn.classList.remove('hidden');
        allBtn.textContent = selectedSessionIds.size === sessions.length && sessions.length > 0 ? '取消全选' : '全选';
        count.classList.remove('hidden');
        count.textContent = `已选 ${selectedSessionIds.size}`;
      }

      function renderSessions() {
        const list = document.getElementById('sessionList');
        const multiBtn = document.getElementById('multiBtn');
        multiBtn.textContent = multiSelectMode ? '退出多选' : '多选';
        multiBtn.className = multiSelectMode
          ? 'text-xs rounded-lg border border-blue-600 text-blue-700 px-2 py-1 bg-blue-50'
          : 'text-xs rounded-lg border border-slate-300 px-2 py-1 hover:bg-slate-100';
        updateSelectionMeta();

        if (!sessions.length) {
          list.innerHTML = '<div class="p-4 text-sm text-slate-500">暂无会话</div>';
          return;
        }

        list.innerHTML = sessions.map(s => {
          const active = s.session_id === currentSessionId;
          const selected = selectedSessionIds.has(s.session_id);
          return `
            <div class="group border-b border-slate-100 ${active ? 'bg-blue-50/70' : 'hover:bg-slate-50'}">
              <div class="p-3 flex items-start gap-2">
                ${multiSelectMode ? `<input type="checkbox" ${selected ? 'checked' : ''} onchange="toggleSelected('${s.session_id}', this.checked)" class="mt-1 h-4 w-4" />` : ''}
                <button onclick="selectSession('${s.session_id}')" class="flex-1 text-left min-w-0">
                  <div class="font-medium text-sm truncate">${escapeHtml(s.title || s.symbol)}</div>
                  <div class="text-xs text-slate-500 mt-1 truncate">${escapeHtml(s.symbol)} · ${escapeHtml(s.config_id)}</div>
                </button>
                <button onclick="deleteOneSession('${s.session_id}')" class="opacity-0 group-hover:opacity-100 transition text-xs rounded-md border border-rose-200 text-rose-600 px-2 py-1 hover:bg-rose-50">删</button>
              </div>
            </div>
          `;
        }).join('');
      }

      async function selectSession(sessionId, options = {}) {
        if (multiSelectMode) return;
        currentSessionId = sessionId;
        if (!options.skipUrlSync) {
          setSessionIdInUrl(sessionId);
        }
        closeMobileSidebar();
        pendingApproval = null;
        showApproval();
        renderSessions();

        const res = await fetch(`/api/chat/sessions/${sessionId}/messages`);
        const data = await res.json();
        if (!data.success) return;
        document.getElementById('chatHeader').textContent = `${data.session.title} (${data.session.symbol} / ${data.session.config_id})`;
        currentMessages = data.messages || [];
        autoScrollEnabled = true;
        renderMessages(currentMessages);
      }

      function renderMessages(messages) {
        const container = ensureMessagesScrollListener();
        const shouldAutoScroll = autoScrollEnabled || isNearBottom(container);
        container.innerHTML = '';

        if (!messages.length) {
          container.innerHTML = '<div class="text-center text-sm text-slate-400 mt-8">暂无消息，开始对话吧</div>';
          return;
        }

        messages.forEach(m => {
          const isUser = m.role === 'user';
          const isTool = m.role === 'tool';
          
          let bubbleClass = '';
          let roleText = '';
          if (isUser) {
            bubbleClass = 'ml-auto mobile-bubble-max sm:max-w-[82%]';
            roleText = '你';
          } else if (isTool) {
            const isError = (m.content || '').toLowerCase().includes('error');
            const isRejected = (m.content || '').toLowerCase().includes('rejected');
            bubbleClass = 'mobile-bubble-max sm:max-w-[90%]';
            roleText = isError ? 'Tool (Error)' : (isRejected ? 'Tool (Rejected)' : 'Tool Result');
          } else {
            bubbleClass = 'mobile-bubble-max sm:max-w-[90%]';
            roleText = 'Agent';
          }

          const el = document.createElement('div');
          el.className = `chat-bubble text-sm break-words ${bubbleClass}`;
          el.dataset.role = isUser ? 'user' : (isTool ? 'tool' : 'assistant');
          if (isTool) {
            const lc = (m.content || '').toLowerCase();
            const isErrorOrRejected = lc.includes('error') || lc.includes('rejected');
            el.dataset.toolState = isErrorOrRejected ? 'error' : 'ok';
          }
          
          let contentHtml = '';
          const hasToolCalls = Array.isArray(m.tool_calls) && m.tool_calls.length > 0;
          
          if (m.content) {
            if (isUser) {
              contentHtml = escapeHtml(m.content);
            } else {
              // 处理 <thinking> 标签
              let displayContent = m.content;
              const thinkingMatch = displayContent.match(/<thinking>([\s\S]*?)<\/thinking>/);
              let thinkingHtml = '';
              
              if (thinkingMatch) {
                const thinkingText = thinkingMatch[1].trim();
                thinkingHtml = `
                  <details class="mb-3 rounded-xl border border-slate-200 bg-slate-50/50 overflow-hidden group" open>
                    <summary class="flex items-center justify-between gap-1.5 px-3 py-2 cursor-pointer hover:bg-slate-100/50 transition-colors list-none select-none">
                      <div class="flex items-center gap-1.5 opacity-60">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9l-.707.707M12 21v-1m4.243-4.243l.707.707m2.828-9.9l.707.707"></path></svg>
                        <span class="text-[11px] font-bold uppercase tracking-wider">Reasoning</span>
                      </div>
                      <svg class="w-3 h-3 opacity-40 transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="px-3 pb-3 pt-1 text-slate-500 italic text-[13px] leading-relaxed border-t border-slate-100/50">
                      ${renderMarkdown(thinkingText)}
                    </div>
                  </details>
                `;
                displayContent = displayContent.replace(/<thinking>[\s\S]*?<\/thinking>/, '').trim();
              } else if (displayContent.includes('<thinking>')) {
                // 处理流式传输中未闭合的标签
                const parts = displayContent.split('<thinking>');
                const beforeThinking = parts[0].trim();
                const thinkingInProgress = parts[1].trim();
                
                if (beforeThinking) {
                    thinkingHtml = renderMarkdown(beforeThinking);
                }
                
                thinkingHtml += `
                  <details class="mb-3 rounded-xl border border-blue-100 bg-blue-50/20 overflow-hidden group animate-pulse" open>
                    <summary class="flex items-center justify-between gap-1.5 px-3 py-2 cursor-pointer list-none select-none">
                      <div class="flex items-center gap-1.5 opacity-60 text-blue-600">
                        <svg class="w-3.5 h-3.5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9l-.707.707M12 21v-1m4.243-4.243l.707.707m2.828-9.9l.707.707"></path></svg>
                        <span class="text-[11px] font-bold uppercase tracking-wider">Thinking...</span>
                      </div>
                      <svg class="w-3 h-3 opacity-40 transition-transform duration-200 group-open:rotate-180 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="px-3 pb-3 pt-1 text-slate-500 italic text-[13px] leading-relaxed border-t border-blue-100/30">
                      ${renderMarkdown(thinkingInProgress)}
                    </div>
                  </details>
                `;
                displayContent = ''; 
              }
              
              contentHtml = thinkingHtml + (displayContent ? renderMarkdown(displayContent) : '');
            }
          } else if (m.__streaming) {
            contentHtml = '<div class="flex items-center gap-1"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>';
          } else if (hasToolCalls) {
            const toolBlocks = m.tool_calls.map(tc => {
              const name = tc.name || 'unknown_tool';
              const args = tc.args || {};
              let argRows = '';
              for (const [key, val] of Object.entries(args)) {
                let displayVal = '';
                if (typeof val === 'object' && val !== null) {
                    displayVal = `<pre class="text-[10px] bg-slate-50 p-1 rounded border border-slate-100 mt-1 overflow-x-auto">${escapeHtml(JSON.stringify(val, null, 2))}</pre>`;
                } else {
                    displayVal = escapeHtml(String(val));
                }
                argRows += `
                  <div class="tool-arg-row">
                    <span class="tool-arg-key">${escapeHtml(key)}</span>
                    <span class="tool-arg-val">${displayVal}</span>
                  </div>
                `;
              }
              return `
                <div class="tool-call-card">
                  <div class="tool-call-head">
                    <svg class="w-3.5 h-3.5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a2 2 0 01-2 2H3a2 2 0 01-2-2V4a2 2 0 114 0v10a2 2 0 002 2h10a2 2 0 012 2v1a2 2 0 11-4 0V14a2 2 0 012-2h10a2 2 0 012 2v1a2 2 0 11-4 0V14a2 2 0 012-2h10a2 2 0 012 2v1a2 2 0 11-4 0"></path></svg>
                    <span class="tool-call-name">${escapeHtml(name)}</span>
                  </div>
                  <div class="tool-call-body">
                    ${argRows || '<span class="text-[11px] text-slate-400">No parameters</span>'}
                  </div>
                </div>
              `;
            }).join('');
            contentHtml = `<div class="text-[11px] text-slate-500 italic mb-1">模型准备执行以下操作：</div>${toolBlocks}`;
          } else {
            contentHtml = '<span class="text-slate-400 text-[11px]">[空响应]</span>';
          }
          
          el.innerHTML = `<div class="text-[10px] uppercase font-bold tracking-wider opacity-60 mb-1.5">${roleText}</div><div class="md-content">${contentHtml}</div>`;
          container.appendChild(el);
        });

        // Add copy buttons to new code blocks
        container.querySelectorAll('pre').forEach(pre => {
          if (pre.querySelector('.copy-btn')) return; // already has a button
          const code = pre.querySelector('code');
          if (!code) return;

          const btn = document.createElement('button');
          btn.textContent = 'Copy';
          btn.className = 'copy-btn';
          btn.onclick = () => {
            navigator.clipboard.writeText(code.textContent).then(() => {
              btn.textContent = 'Copied!';
              setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
            });
          };
          pre.appendChild(btn);
        });

        if (shouldAutoScroll) {
          container.scrollTop = container.scrollHeight;
          autoScrollEnabled = true;
        }
        updateJumpToBottomButton();
      }

      async function sendMessage() {
        autoScrollEnabled = true;
        if (!currentSessionId || pendingApproval) return;
        const input = document.getElementById('input');
        const message = input.value.trim();
        if (!message) return;
        input.value = '';
        input.style.height = '40px';
        input.disabled = true;

        currentMessages.push({ role: 'user', content: message });
        currentMessages.push({ role: 'assistant', content: '', __streaming: true });
        const streamAssistantIndex = currentMessages.length - 1;
        renderMessages(currentMessages);

        const eventSource = new EventSource(`/api/chat/sessions/${currentSessionId}/stream?message=${encodeURIComponent(message)}`);
        let streamClosed = false;

        eventSource.onmessage = function(event) {
          const payload = JSON.parse(event.data);

          if (payload.type === 'token') {
            currentMessages[streamAssistantIndex].content += payload.token || '';
            scheduleStreamRender(currentMessages);
          } else if (payload.type === 'done') {
            currentMessages = payload.messages || currentMessages;
            currentMessages = currentMessages.map(m => {
              if (m && m.__streaming) {
                const copy = { ...m };
                delete copy.__streaming;
                return copy;
              }
              return m;
            });
            pendingApproval = payload.pending_approval || null;
            scheduleStreamRender(currentMessages, true);
            showApproval();
            streamClosed = true;
            eventSource.close();
            input.disabled = false;
            input.focus();
            bootstrap(); // Refresh session list to show updated timestamp
          } else if (payload.type === 'error') {
            streamClosed = true;
            if (currentMessages[streamAssistantIndex] && currentMessages[streamAssistantIndex].__streaming) {
              currentMessages[streamAssistantIndex].__streaming = false;
              currentMessages[streamAssistantIndex].content = currentMessages[streamAssistantIndex].content || '[流式失败]';
              scheduleStreamRender(currentMessages, true);
            }
            alert(payload.message || '流式传输失败');
            eventSource.close();
            input.disabled = false;
          }
        };

        eventSource.onerror = function() {
          if (streamClosed) return;
          if (currentMessages[streamAssistantIndex] && currentMessages[streamAssistantIndex].__streaming) {
            currentMessages[streamAssistantIndex].__streaming = false;
            currentMessages[streamAssistantIndex].content = currentMessages[streamAssistantIndex].content || '[连接中断]';
            scheduleStreamRender(currentMessages, true);
          }
          alert('与服务器的连接丢失。');
          eventSource.close();
          input.disabled = false;
        };
      }

      async function respondApproval(approved) {
        if (!currentSessionId || !pendingApproval || approvalLoading) return;

        // --- 核心优化：立即隐藏审批栏 ---
        const bar = document.getElementById('approvalBar');
        if (bar) bar.classList.add('hidden');

        autoScrollEnabled = true;
        setApprovalLoading(true);

        // 在消息列表中插入一条临时的“系统提示”气泡
        const tempMsg = { 
            role: 'assistant', 
            content: approved ? '_正在执行工具操作，请稍候..._' : '_已拒绝工具执行申请。_',
            __loading: true 
        };
        currentMessages.push(tempMsg);
        renderMessages(currentMessages);

        currentMessages.push({ role: 'assistant', content: '', __streaming: true });
        const streamAssistantIndex = currentMessages.length - 1;

        const eventSource = new EventSource(`/api/chat/sessions/${currentSessionId}/stream?approval=${approved ? 'true' : 'false'}`);
        let streamClosed = false;

        eventSource.onmessage = function(event) {
          const payload = JSON.parse(event.data);

          // 移除之前的临时提示气泡
          if (payload.type === 'token' || payload.type === 'done') {
              currentMessages = currentMessages.filter(m => !m.__loading);
          }

          if (payload.type === 'token') {
            currentMessages[streamAssistantIndex].content += payload.token || '';
            scheduleStreamRender(currentMessages);
          } else if (payload.type === 'done') {
            currentMessages = payload.messages || currentMessages;
            pendingApproval = payload.pending_approval || null;
            scheduleStreamRender(currentMessages, true);
            showApproval();
            streamClosed = true;
            setApprovalLoading(false);
            eventSource.close();
            bootstrap();
          }
 else if (payload.type === 'error') {
            streamClosed = true;
            if (currentMessages[streamAssistantIndex] && currentMessages[streamAssistantIndex].__streaming) {
              currentMessages[streamAssistantIndex].__streaming = false;
              currentMessages[streamAssistantIndex].content = currentMessages[streamAssistantIndex].content || '[审批流式失败]';
              scheduleStreamRender(currentMessages, true);
            }
            setApprovalLoading(false);
            alert(payload.message || '审批失败');
            eventSource.close();
          }
        };

        eventSource.onerror = function() {
          if (streamClosed) return;
          if (currentMessages[streamAssistantIndex] && currentMessages[streamAssistantIndex].__streaming) {
            currentMessages[streamAssistantIndex].__streaming = false;
            currentMessages[streamAssistantIndex].content = currentMessages[streamAssistantIndex].content || '[审批连接中断]';
            scheduleStreamRender(currentMessages, true);
          }
          setApprovalLoading(false);
          alert('与服务器的连接丢失。');
          eventSource.close();
        };
      }

      function showApproval() {
        const bar = document.getElementById('approvalBar');
        const txt = document.getElementById('approvalText');
        const yesBtn = document.getElementById('approvalYesBtn');
        if (yesBtn) yesBtn.textContent = '同意执行'; // Reset text

        if (!pendingApproval || !pendingApproval.value) {
          bar.classList.add('hidden');
          txt.innerHTML = '';
          setApprovalLoading(false);
          return;
        }
        const v = pendingApproval.value;
        const name = v.tool_name || 'unknown';
        const args = v.tool_args || {};
        let argSummary = '';
        for (const [key, val] of Object.entries(args)) {
          let valText = '';
          if (typeof val === 'object' && val !== null) {
              valText = JSON.stringify(val);
          } else {
              valText = String(val);
          }
          argSummary += `<span class="inline-block bg-white border border-amber-200 rounded px-1 text-[10px] mr-1 max-w-[200px] truncate" title="${escapeHtml(valText)}">${escapeHtml(key)}: ${escapeHtml(valText)}</span>`;
        }

        txt.innerHTML = `
          <div class="inline-flex items-center gap-2 max-w-full overflow-hidden">
            <span class="bg-amber-100 text-amber-800 px-1.5 py-0.5 rounded text-[11px] font-bold border border-amber-200 uppercase flex-shrink-0">${escapeHtml(name)}</span>
            <div class="flex flex-wrap gap-y-1 items-center min-w-0">${argSummary}</div>
          </div>
        `;
        bar.classList.remove('hidden');
      }

      async function deleteOneSession(sessionId) {
        if (!confirm('确定删除这个会话吗？')) return;
        const res = await fetch(`/api/chat/sessions/${sessionId}`, { method: 'DELETE' });
        const data = await res.json();
        if (!data.success) {
          alert(data.message || '删除失败');
          return;
        }

        selectedSessionIds.delete(sessionId);
        if (currentSessionId === sessionId) {
          currentSessionId = null;
          currentMessages = [];
          setSessionIdInUrl(null);
          pendingApproval = null;
          showApproval();
          document.getElementById('chatHeader').textContent = '请选择或新建会话';
          renderMessages([]);
        }
        await bootstrap();
      }

      async function deleteSelectedSessions() {
        if (!selectedSessionIds.size) return;
        if (!confirm(`确定删除选中的 ${selectedSessionIds.size} 个会话吗？`)) return;

        const ids = Array.from(selectedSessionIds);
        const res = await fetch('/api/chat/sessions', {
          method: 'DELETE',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ session_ids: ids })
        });
        const data = await res.json();
        if (!data.success) {
          alert(data.message || '批量删除失败');
          return;
        }

        if (currentSessionId && selectedSessionIds.has(currentSessionId)) {
          currentSessionId = null;
          currentMessages = [];
          setSessionIdInUrl(null);
          pendingApproval = null;
          showApproval();
          document.getElementById('chatHeader').textContent = '请选择或新建会话';
          renderMessages([]);
        }
        selectedSessionIds.clear();
        multiSelectMode = false;
        await bootstrap();
      }

      async function openNewSession() {
        if (!configs.length) {
          // Ensure configs are ready even when user clicks quickly after page load.
          await bootstrap();
        }
        const select = document.getElementById('configSelect');
        select.innerHTML = configs.map(c => {
          const configId = (c.config_id || '').trim();
          const labelId = configId || 'MISSING_CONFIG_ID';
          return `<option value="${escapeHtml(configId)}">[${escapeHtml(labelId)}] ${escapeHtml(c.symbol)} · ${escapeHtml(c.mode)}</option>`;
        }).join('');
        document.getElementById('sessionTitle').value = '';
        document.getElementById('newSessionModal').classList.remove('hidden');
      }

      function closeNewSession() {
        document.getElementById('newSessionModal').classList.add('hidden');
      }

      async function createSession() {
        const configId = document.getElementById('configSelect').value;
        const title = document.getElementById('sessionTitle').value.trim();
        const res = await fetch('/api/chat/sessions', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ config_id: configId, title })
        });
        const data = await res.json();
        if (!data.success) {
          alert(data.message || '创建失败');
          return;
        }
        closeNewSession();
        await bootstrap();
        await selectSession(data.session.session_id);
      }

      function escapeHtml(str) {
        return String(str || '').replace(/[&<>"']/g, (s) => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[s]));
      }

      {% if authed %}
      bootstrap();
      {% endif %}
    </script>
  </body>
</html>
