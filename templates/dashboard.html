<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta http-equiv="refresh" content="30" />
    <title>{{ current_symbol }} é‡åŒ–å æœºä»“</title>
    <link
      href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f8f9fa; /* æ›´æŸ”å’Œçš„ç°åº• */
        --card: #ffffff;
        --text-main: #1f2937;
        --text-sub: #6b7280;
        --border: #e5e7eb;

        /* äº¤æ˜“æ–¹å‘é¢œè‰² */
        --buy-text: #00b42a;
        --buy-bg: #e8ffea;
        --sell-text: #f53f3f;
        --sell-bg: #ffecec;

        /* âœ… è¡¨æ ¼è¡Œæ ·å¼ä¼˜åŒ– */
        --real-row-bg: #ffffff;
        --real-row-hover: #fff5f5;
        --real-border-color: #ef4444;

        --strat-row-bg: #ffffff;
        --strat-row-hover: #f0f9ff;
        --strat-border-color: #3b82f6;

        /* å¾½ç«  Badge é¢œè‰² */
        --badge-real-bg: #fee2e2;
        --badge-real-text: #b91c1c;
        --badge-strat-bg: #dbeafe;
        --badge-strat-text: #1d4ed8;
      }

      body {
        background-color: var(--bg);
        color: var(--text-main);
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        font-size: 14px;
        -webkit-font-smoothing: antialiased;
      }

      /* å¯¼èˆªæ ä¼˜åŒ– */
      .navbar {
        background: var(--card);
        border-bottom: 1px solid var(--border);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        padding: 10px 0;
      }
      .nav-title {
        font-weight: 700;
        font-size: 1.1rem;
        letter-spacing: -0.5px;
      }

      /* çŠ¶æ€æ¡ */
      .status-bar {
        background: #fffbeb;
        border-bottom: 1px solid #fcd34d;
        color: #92400e;
        padding: 8px 0;
        font-size: 0.85rem;
      }
      .live-dot {
        width: 8px;
        height: 8px;
        background-color: #10b981;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        animation: pulse-green 2s infinite;
      }
      @keyframes pulse-green {
        0% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        70% {
          box-shadow: 0 0 0 4px rgba(16, 185, 129, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
      }

      .main-container {
        padding: 24px;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Agent Cards */
      .agents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .agent-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        display: flex;
        flex-direction: column;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }
      .agent-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06);
      }
      .agent-header {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        background: #fcfcfc;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 12px 12px 0 0;
      }
      .agent-body {
        padding: 16px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .logic-box {
        background: #f8fafc;
        border-left: 3px solid #64748b;
        padding: 10px 14px;
        border-radius: 4px;
        margin-top: auto;
        font-size: 0.85rem;
      }

      /* Orders Table Styling */
      .orders-section {
        background: var(--card);
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        overflow: hidden;
      }
      .section-header {
        padding: 16px 24px;
        font-weight: 700;
        font-size: 1.05rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .table {
        margin-bottom: 0;
        width: 100%;
      }
      .table th {
        background: #f9fafb;
        color: var(--text-sub);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        padding: 12px 24px;
        border-bottom: 1px solid var(--border);
        border-top: none;
      }
      .table td {
        padding: 16px 24px;
        vertical-align: middle;
        border-bottom: 1px solid var(--border);
        color: #374151;
        background: var(--real-row-bg);
        transition: background 0.15s ease-in-out;
      }

      /* å·¦ä¾§çŠ¶æ€æ¡é€»è¾‘ */
      .table tbody tr {
        position: relative;
      }

      /* å®ç›˜æ¨¡å¼ */
      .row-real td:first-child {
        box-shadow: inset 4px 0 0 var(--real-border-color);
      }
      .row-real:hover td {
        background-color: var(--real-row-hover) !important;
      }

      /* ç­–ç•¥æ¨¡å¼ */
      .row-strat td:first-child {
        box-shadow: inset 4px 0 0 var(--strat-border-color);
      }
      .row-strat:hover td {
        background-color: var(--strat-row-hover) !important;
      }

      /* æ ‡ç­¾ä¸å¾½ç«  */
      .mode-badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
      }
      .mode-real {
        background: var(--badge-real-bg);
        color: var(--badge-real-text);
      }
      .mode-strat {
        background: var(--badge-strat-bg);
        color: var(--badge-strat-text);
      }

      .tag-buy {
        background: var(--buy-bg);
        color: var(--buy-text);
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 600;
      }
      .tag-sell {
        background: var(--sell-bg);
        color: var(--sell-text);
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 600;
      }

      .tp-sl-box {
        display: flex;
        flex-direction: column;
        gap: 2px;
        font-size: 0.85rem;
        font-family: "SF Mono", Consolas, monospace;
      }
      .val-tp {
        color: #00b42a;
      }
      .val-sl {
        color: #f53f3f;
      }
      .label-mini {
        font-size: 0.7em;
        color: #9ca3af;
        margin-right: 4px;
      }

      /* Mobile é€‚é… */
      @media (max-width: 768px) {
        .main-container {
          padding: 12px;
        }
        .table thead {
          display: none;
        }
        .table tbody tr {
          display: block;
          border-bottom: 8px solid var(--bg);
        }
        .table td {
          display: flex;
          justify-content: space-between;
          padding: 10px 16px;
          border-bottom: 1px solid #f3f4f6;
        }
        .table td:last-child {
          border-bottom: none;
        }
        .table td::before {
          content: attr(data-label);
          font-weight: 600;
          color: var(--text-sub);
        }
        .row-real td:first-child,
        .row-strat td:first-child {
          box-shadow: none;
          border-left: 4px solid transparent;
        }
        .row-real {
          border-left: 4px solid var(--real-border-color);
        }
        .row-strat {
          border-left: 4px solid var(--strat-border-color);
        }
        .reason-cell {
          display: block;
          margin-top: 5px;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar sticky-top">
      <div class="container-fluid" style="max-width: 1400px">
        <div class="d-flex justify-content-between align-items-center w-100">
          <div class="nav-title">
            <span>ğŸ“‰ é‡åŒ–å æœºä»“</span>
          </div>
          <div class="d-flex gap-2">
            <select
              class="form-select form-select-sm shadow-none"
              style="width: auto; border-color: var(--border)"
              onchange="window.location.href = '?symbol=' + this.value"
            >
              {% for sym in symbols %}
              <option
                value="{{ sym }}"
                {%
                if
                sym=""
                ="current_symbol"
                %}selected{%
                endif
                %}
              >
                {{ sym }}
              </option>
              {% endfor %}
            </select>
            <button
              class="btn btn-sm btn-outline-secondary"
              onclick="location.reload()"
            >
              â†º
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="status-bar">
      <div class="container-fluid" style="max-width: 1400px">
        <div class="d-flex justify-content-between flex-wrap gap-2">
          <div>
            <span class="live-dot"></span>
            <strong>è¿è¡ŒçŠ¶æ€:</strong> æ­£å¸¸ | <strong>å½“å‰æ¨¡å¼:</strong> {{
            scheduler_mode }}
          </div>
          <div style="color: #b91c1c; font-weight: 500">
            âš¡ æ³¨æ„: å®ç›˜æ¨¡å¼å·²æ¥å…¥é£æ§æ¨¡å— (Limit TP/SL)
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <div class="agents-grid">
        {% if agent_summaries %} {% for summary in agent_summaries %}
        <div class="agent-card">
          <div class="agent-header">
            <div
              style="
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 8px;
              "
            >
              <span>ğŸ¤–</span> {{ summary.agent_name or 'Unknown' }}
            </div>
            <small class="text-muted"
              >{{ summary.timestamp.split(' ')[1] }}</small
            >
          </div>
          <div class="agent-body">
            <div style="font-size: 0.9rem; line-height: 1.6; color: #334155">
              {{ summary.content }}
            </div>
            <div class="logic-box">
              <div
                style="
                  font-size: 0.7rem;
                  text-transform: uppercase;
                  color: #64748b;
                  margin-bottom: 4px;
                  font-weight: 700;
                "
              >
                Logic & Thought
              </div>
              {{ summary.strategy_logic }}
            </div>
          </div>
        </div>
        {% endfor %} {% else %}
        <div class="text-center w-100 py-5 text-muted">æš‚æ—  Agent æ´»è·ƒæ•°æ®</div>
        {% endif %}
      </div>

      <div class="orders-section">
        <div class="section-header">
          <span>ğŸ“œ æ‰§è¡Œè®°å½•</span>
          <span class="badge bg-light text-dark border"
            >{{ total_orders }}</span
          >
        </div>

        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th width="8%">ID</th>
                <th width="8%">æ¨¡å¼</th>
                <th>Agent</th>
                <th width="12%">æ—¶é—´</th>
                <th width="8%">æ–¹å‘</th>
                <th width="12%">ä»·æ ¼ / è§¦å‘</th>
                <th width="15%">é£æ§ (TP / SL)</th>
                <th width="25%">ç­–ç•¥ç†ç”±</th>
              </tr>
            </thead>
            <tbody>
              {% for order in orders %}
              <tr
                class="{% if order.trade_mode == 'REAL' %}row-real{% else %}row-strat{% endif %}"
              >
                <td data-label="ID">
                  <small style="font-family: monospace; color: var(--text-sub)"
                    >#{{ order.order_id }}</small
                  >
                </td>

                <td data-label="æ¨¡å¼">
                  {% if order.trade_mode == 'REAL' %}
                  <span class="mode-badge mode-real">å®ç›˜</span>
                  {% else %}
                  <span class="mode-badge mode-strat">ç­–ç•¥</span>
                  {% endif %}
                </td>

                <td data-label="Agent">
                  <span
                    style="font-weight: 600; font-size: 0.85rem; color: #4b5563"
                  >
                    {{ order.agent_name if order.agent_name else 'System' }}
                  </span>
                </td>

                <td data-label="æ—¶é—´">
                  <span style="color: var(--text-sub); font-size: 0.85rem"
                    >{{ order.timestamp }}</span
                  >
                </td>

                <td data-label="æ–¹å‘">
                  <span
                    class="tag {% if 'buy' in order.side|lower %}tag-buy{% elif 'sell' in order.side|lower %}tag-sell{% else %}bg-light{% endif %}"
                  >
                    {{ order.side }}
                  </span>
                </td>

                <td data-label="ä»·æ ¼">
                  <div style="font-weight: 600">
                    {% if order.trigger_price and order.trigger_price > 0 %}
                    <span style="color: #d97706" title="è§¦å‘ä»·"
                      >âš¡ {{ order.trigger_price }}</span
                    >
                    {% else %} {{ order.entry_price }} {% endif %}
                  </div>
                </td>

                <td data-label="é£æ§">
                  <div class="tp-sl-box">
                    <div>
                      <span class="label-mini">TP</span>
                      {% if order.take_profit and order.take_profit > 0 %}
                      <span class="val-tp">{{ order.take_profit }}</span>
                      {% else %}
                      <span class="text-muted">-</span>
                      {% endif %}
                    </div>
                    <div>
                      <span class="label-mini">SL</span>
                      {% if order.stop_loss and order.stop_loss > 0 %}
                      <span class="val-sl">{{ order.stop_loss }}</span>
                      {% else %}
                      <span class="text-muted">-</span>
                      {% endif %}
                    </div>
                  </div>
                </td>

                <td data-label="ç†ç”±" class="reason-cell">
                  <div
                    style="font-size: 0.85rem; line-height: 1.4; color: #4b5563"
                  >
                    {{ order.reason }}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="p-3 border-top bg-light d-flex justify-content-end">
          <nav>
            <ul class="pagination pagination-sm mb-0">
              <li
                class="page-item {% if current_page <= 1 %}disabled{% endif %}"
              >
                <a
                  class="page-link"
                  href="?symbol={{current_symbol}}&page={{current_page-1}}"
                  >Previous</a
                >
              </li>
              <li class="page-item disabled">
                <span class="page-link"
                  >{{ current_page }} / {{ total_pages }}</span
                >
              </li>
              <li
                class="page-item {% if current_page >= total_pages %}disabled{% endif %}"
              >
                <a
                  class="page-link"
                  href="?symbol={{current_symbol}}&page={{current_page+1}}"
                  >Next</a
                >
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </body>
</html>
