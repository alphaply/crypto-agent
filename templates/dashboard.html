<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>{{ current_symbol }} - è‡ªåŠ¨äºé’±Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'buy': '#059669',      // ä¹°å…¥ç»¿
              'sell': '#dc2626',     // å–å‡ºçº¢
            }
          }
        }
      }
    </script>
    <style>
      /* å°‘é‡å¿…è¦çš„è‡ªå®šä¹‰æ ·å¼ï¼šéšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      /* åŠ¨ç”» */
      @keyframes pulse-custom {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .animate-pulse-custom { animation: pulse-custom 2s infinite; }
      
      /* çº¢è‰²å‘¼å¸ç¯åŠ¨ç”» */
      @keyframes pulse-red {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
      }
      .animate-pulse-red { animation: pulse-red 1.5s infinite; }
      
      /* Tooltip åœ¨æ‰‹æœºç«¯ç‚¹å‡»æ˜¾ç¤ºçš„è¾…åŠ© */
      .tooltip-container:active .tooltip-content,
      .tooltip-container:focus-within .tooltip-content {
        display: block;
      }

      /* å¤åˆ¶æˆåŠŸçš„æµ®åŠ¨æç¤ºåŠ¨ç”» */
      @keyframes fade-out-up {
        0% { opacity: 1; transform: translate(-50%, 0); }
        100% { opacity: 0; transform: translate(-50%, -20px); }
      }
      .copy-feedback {
        position: fixed;
        z-index: 9999;
        background: rgba(17, 24, 39, 0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        animation: fade-out-up 1s ease-out forwards;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800 font-sans antialiased overflow-x-hidden selection:bg-blue-100">

    <nav class="sticky top-0 z-50 bg-white/95 backdrop-blur shadow-sm border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col sm:flex-row justify-between items-center py-3 gap-3">
          <div class="font-bold text-lg tracking-tight text-gray-900 flex items-center gap-2">
            <span class="flex items-center gap-2">
                ğŸ’¸ <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">è‡ªåŠ¨äºé’±Agent</span>
            </span>
            
            <a href="https://github.com/alphaply/crypto-agent" target="_blank" class="ml-2 text-gray-400 hover:text-gray-900 transition-colors" title="GitHub Repository">
                <svg viewBox="0 0 24 24" class="h-6 w-6 fill-current" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
            </a>
          </div>
          
          <div class="flex w-full sm:w-auto items-center gap-2 justify-between sm:justify-end">
             <select
              id="symbolSelect"
              onchange="window.location.href = '?symbol=' + this.value"
              class="form-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 outline-none flex-grow sm:flex-grow-0 sm:w-40"
            >
              {% for sym in symbols %} 
                <option value="{{ sym }}" {% if sym == current_symbol %}selected{% endif %}>{{ sym }}</option>
              {% endfor %}
            </select>
            
            <div class="flex gap-2">
                <div class="inline-flex rounded-md shadow-sm" role="group">
                    <a href="/history?symbol={{ current_symbol }}" title="å†å²å›æº¯" class="px-3 py-2 text-sm font-medium text-blue-600 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 flex items-center justify-center min-w-[42px]">
                       ğŸ“œ
                    </a>
                    <button onclick="confirmDelete()" title="æ¸…é™¤å†å²" class="px-3 py-2 text-sm font-medium text-red-600 bg-white border border-l-0 border-gray-200 rounded-r-lg hover:bg-gray-100 hover:text-red-700 focus:z-10 focus:ring-2 focus:ring-red-700 focus:text-red-700 flex items-center justify-center min-w-[42px]">
                       ğŸ—‘ï¸
                    </button>
                </div>

                <button
                  onclick="location.reload()"
                  title="åˆ·æ–°"
                  class="p-2 text-gray-500 bg-white border border-gray-200 rounded-lg hover:bg-gray-100 hover:text-gray-900 focus:ring-2 focus:ring-gray-200"
                >
                  â†»
                </button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="bg-amber-50 border-b border-amber-200 text-amber-900 text-sm">
      <div class="max-w-7xl mx-auto px-4 py-2 sm:px-6 lg:px-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
          <div class="flex flex-wrap items-center gap-x-4 gap-y-1">
            <span class="flex items-center gap-2">
                <!-- æ ¹æ®è°ƒåº¦å™¨çŠ¶æ€æ˜¾ç¤ºä¸åŒé¢œè‰²å’ŒåŠ¨ç”» -->
                {% if scheduler_enabled %}
                <span class="w-2.5 h-2.5 bg-emerald-500 rounded-full animate-pulse-custom"></span>
                <span class="font-medium">è¿è¡Œä¸­</span>
                {% else %}
                <span class="w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse-red"></span>
                <span class="font-medium text-red-500">åœæ­¢è¿è¡Œ</span>
                {% endif %}
            </span>
            <span class="text-amber-300 hidden sm:inline">|</span>
            <span>æ¨¡å¼: <span class="font-bold text-amber-800">{{ symbol_mode }}</span></span>
            <span class="text-amber-300 hidden sm:inline">|</span>
            <span>é¢‘ç‡: <span class="font-bold text-emerald-700">{{ symbol_freq }}</span></span>
          </div>
          <div>
            é£æ§ç³»ç»Ÿ: <span class="font-bold text-emerald-600">å·²å¯åŠ¨</span>
          </div>
        </div>
      </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 auto-rows-fr">
        {% if agent_summaries %} {% for summary in agent_summaries %}
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-shadow flex flex-col overflow-hidden h-full">
          <div class="px-5 py-3 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
            <span class="font-bold text-gray-900 flex items-center gap-2 truncate">
                ğŸ¤– {{ summary.agent_name or 'AI-Agent' }}
            </span>
            <span class="text-xs font-mono text-gray-500 bg-gray-100 px-2 py-1 rounded whitespace-nowrap">
              {{ summary.timestamp }}
            </span>
          </div>
          <div class="p-5 flex flex-col gap-4 flex-grow">
            <div class="text-gray-700 text-sm leading-relaxed whitespace-pre-wrap">{{ summary.content }}</div>
            
            <div class="mt-auto bg-blue-50 border-l-4 border-blue-500 p-3 rounded-r text-sm text-blue-900">
              <div class="font-bold text-xs uppercase text-blue-400 mb-1">Strategy Logic</div>
              <div class="whitespace-pre-wrap">{{ summary.strategy_logic }}</div>
            </div>
          </div>
        </div>
        {% endfor %} {% else %}
        <div class="col-span-full text-center py-12 bg-white rounded-xl border border-dashed border-gray-300 text-gray-500">
           <p class="text-lg">æš‚æ— åˆ†ææ•°æ®ï¼Œæ­£åœ¨ç­‰å¾… Agent äºé’±...</p>
        </div>
        {% endif %}
      </div>

      <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50/50">
          <h3 class="font-bold text-gray-900 text-lg">ğŸ“œ äºé’±æ—¥å¿—</h3>
          <span class="bg-gray-100 text-gray-600 text-xs font-medium px-2.5 py-0.5 rounded border border-gray-200">
            Total: {{ total_orders }}
          </span>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left text-gray-600">
            <thead class="hidden md:table-header-group text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="px-6 py-3 font-medium w-32">æ—¶é—´</th>
                <th class="px-6 py-3 font-medium">Order ID</th>
                <th class="px-6 py-3 font-medium text-center w-24">æ¨¡å¼</th>
                <th class="px-6 py-3 font-medium">Agent</th>
                <th class="px-6 py-3 font-medium text-center w-24">æ–¹å‘</th>
                <th class="px-6 py-3 font-medium">ä»·æ ¼/è§¦å‘</th>
                <th class="px-6 py-3 font-medium">é£æ§ (TP/SL)</th>
                <th class="px-6 py-3 font-medium min-w-[200px]">ç†ç”±</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              {% for order in orders %}
              <tr class="bg-white hover:bg-gray-50 flex flex-col md:table-row mb-4 md:mb-0 border md:border-none rounded-lg md:rounded-none shadow-sm md:shadow-none m-4 md:m-0 p-4 md:p-0">
                
                <td class="px-6 py-2 md:py-4 flex justify-between md:table-cell align-top">
                  <span class="md:hidden font-semibold text-gray-500 text-xs uppercase flex-shrink-0 mr-4">æ—¶é—´</span>
                  <span class="font-mono text-xs text-gray-500 whitespace-nowrap">{{ order.timestamp }}</span>
                </td>

                <td class="px-6 py-2 md:py-4 flex justify-between md:table-cell align-top relative">
                    <span class="md:hidden font-semibold text-gray-500 text-xs uppercase flex-shrink-0 mr-4">Order ID</span>
                    {% if order.order_id %}
                    <div class="tooltip-container group relative cursor-pointer inline-block">
                        <span class="font-mono text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded border border-gray-200 truncate max-w-[80px] md:max-w-[100px] block">
                            {{ order.order_id }}
                        </span>
                        <div class="tooltip-content hidden group-hover:block absolute bottom-full left-0 mb-1 z-50 w-max max-w-[240px] break-all bg-gray-800 text-white text-xs rounded p-2 shadow-xl border border-gray-700">
                            {{ order.order_id }}
                            <div class="absolute top-full left-4 -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                        </div>
                    </div>
                    {% else %}
                    <span class="text-gray-300">-</span>
                    {% endif %}
                </td>

                <td class="px-6 py-2 md:py-4 flex justify-between md:table-cell md:text-center align-top">
                    <span class="md:hidden font-semibold text-gray-500 text-xs uppercase">æ¨¡å¼</span>
                    {% if order.trade_mode == 'REAL' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-red-600 text-white shadow-sm">å®ç›˜</span>
                    {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-600 text-white shadow-sm">ç­–ç•¥</span>
                    {% endif %}
                </td>

                <td class="px-6 py-2 md:py-4 flex justify-between md:table-cell align-top relative">
                    <span class="md:hidden font-semibold text-gray-500 text-xs uppercase">Agent</span>
                    <div class="tooltip-container group relative cursor-pointer inline-block">
                         <span class="font-semibold text-gray-700 truncate max-w-[100px] md:max-w-[140px] block">
                            {{ order.agent_name or 'System' }}
                        </span>
                        <div class="tooltip-content hidden group-hover:block absolute bottom-full left-0 mb-1 z-50 w-max max-w-[200px] bg-gray-800 text-white text-xs rounded p-2 shadow-xl border border-gray-700 whitespace-normal">
                            {{ order.agent_name or 'System' }}
                            <div class="absolute top-full left-4 -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                        </div>
                    </div>
                </td>

                <td class="px-6 py-2 md:py-4 flex justify-between md:table-cell md:text-center align-top">
                    <span class="md:hidden font-semibold text-gray-500 text-xs uppercase">æ–¹å‘</span>
                    
                    {% set s = order.side|lower %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-bold uppercase shadow-sm
                        {% if 'buy' in s %} bg-emerald-100 text-emerald-800 border border-emerald-200
                        {% elif 'sell' in s %} bg-red-100 text-red-800 border border-red-200
                        {% elif 'close' in s %} bg-orange-100 text-orange-800 border border-orange-200
                        {% elif 'cancel' in s %} bg-slate-200 text-slate-600 border border-slate-300
                        {% else %} bg-gray-100 text-gray-800 border border-gray-200 {% endif %}">
                        {{ order.side|upper }}
                    </span>
                </td>

                <td class="px-6 py-2 md:py-4 flex justify-between md:table-cell align-top">
                    <span class="md:hidden font-semibold text-gray-500 text-xs uppercase">ä»·æ ¼</span>
                    {% if order.trigger_price and order.trigger_price > 0 %}
                    <span 
                        onclick="handleCopy('{{ order.trigger_price }}', event)" 
                        class="cursor-pointer font-mono font-bold text-amber-600 hover:text-amber-800 border-b border-dashed border-amber-300 hover:border-amber-600 transition-colors" 
                        title="ç‚¹å‡»å¤åˆ¶">âš¡ {{ order.trigger_price }}
                    </span>
                    {% else %}
                    <span 
                        onclick="handleCopy('{{ order.entry_price }}', event)" 
                        class="cursor-pointer font-mono font-bold text-gray-900 hover:text-blue-600 border-b border-dashed border-gray-300 hover:border-blue-500 transition-colors" 
                        title="ç‚¹å‡»å¤åˆ¶">{{ order.entry_price }}
                    </span>
                    {% endif %}
                </td>

                <td class="px-6 py-2 md:py-4 flex justify-between md:table-cell align-top">
                    <span class="md:hidden font-semibold text-gray-500 text-xs uppercase">é£æ§</span>
                    <div class="flex gap-3 text-xs font-mono">
                        <div class="flex items-center gap-1">
                            <span class="text-gray-400">TP</span>
                            <span 
                                onclick="handleCopy('{{ order.take_profit }}', event)"
                                class="cursor-pointer font-bold {% if order.take_profit > 0 %}text-buy border-b border-dashed border-emerald-200 hover:border-emerald-500{% else %}text-gray-300{% endif %}"
                                title="ç‚¹å‡»å¤åˆ¶"
                            >
                                {{ order.take_profit if order.take_profit > 0 else '--' }}
                            </span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="text-gray-400">SL</span>
                            <span 
                                onclick="handleCopy('{{ order.stop_loss }}', event)"
                                class="cursor-pointer font-bold {% if order.stop_loss > 0 %}text-sell border-b border-dashed border-red-200 hover:border-red-500{% else %}text-gray-300{% endif %}"
                                title="ç‚¹å‡»å¤åˆ¶"
                            >
                                {{ order.stop_loss if order.stop_loss > 0 else '--' }}
                            </span>
                        </div>
                    </div>
                </td>

                <td class="px-6 py-2 md:py-4 md:table-cell w-full md:w-auto align-top">
                    <span class="md:hidden font-semibold text-gray-500 text-xs uppercase block mb-1">ç†ç”±</span>
                    <div class="bg-gray-50 rounded p-2 text-xs text-gray-600 leading-snug break-words">
                        {{ order.reason }}
                    </div>
                </td>

              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end">
          <nav class="inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
            <a href="?symbol={{current_symbol}}&page={{current_page-1}}" class="{% if current_page <= 1 %}pointer-events-none opacity-50{% endif %} relative inline-flex items-center px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50">
              ä¸Šä¸€é¡µ
            </a>
            <span class="relative inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border-t border-b border-gray-300">
              {{ current_page }} / {{ total_pages }}
            </span>
            <a href="?symbol={{current_symbol}}&page={{current_page+1}}" class="{% if current_page >= total_pages %}pointer-events-none opacity-50{% endif %} relative inline-flex items-center px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50">
              ä¸‹ä¸€é¡µ
            </a>
          </nav>
        </div>
      </div>
    </main>

    <script>
    // å¤åˆ¶åŠŸèƒ½å‡½æ•°
    function handleCopy(text, event) {
        // é˜²æ­¢æ•°å€¼æ— æ•ˆæ—¶å¤åˆ¶
        if (!text || text === '0' || text === '--' || text === '0.0') return;
        
        navigator.clipboard.writeText(text).then(() => {
            showCopyFeedback(event.clientX, event.clientY);
        }).catch(err => {
            console.error('Copy failed:', err);
        });
    }

    // æ˜¾ç¤ºå¤åˆ¶åé¦ˆåŠ¨ç”»
    function showCopyFeedback(x, y) {
        const el = document.createElement('div');
        el.className = 'copy-feedback';
        el.innerText = 'å·²å¤åˆ¶';
        
        // æ”¾ç½®åœ¨é¼ æ ‡ç‚¹å‡»ä½ç½®ä¸Šæ–¹
        el.style.left = x + 'px';
        el.style.top = (y - 10) + 'px';
        
        document.body.appendChild(el);
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤ DOM
        setTimeout(() => {
            el.remove();
        }, 1000);
    }

    async function confirmDelete() {
        const symbol = document.getElementById('symbolSelect').value;
        const msg = `âš ï¸ é«˜å±æ“ä½œ warning \n\næ‚¨ç¡®å®šè¦æ¸…ç©º [ ${symbol} ] çš„æ‰€æœ‰ Agent åˆ†æå†å²å—ï¼Ÿ\n(è®¢å•è®°å½•ä¸ä¼šè¢«åˆ é™¤)`;
        
        if (confirm(msg)) {
            const password = prompt("ğŸ” è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥ç¡®è®¤åˆ é™¤:");
            if (password) {
                try {
                    const response = await fetch('/api/clean_history', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbol: symbol, password: password })
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert("âœ… " + result.message);
                        location.reload();
                    } else {
                        alert("âŒ å¤±è´¥: " + result.message);
                    }
                } catch (e) {
                    alert("ç½‘ç»œé”™è¯¯: " + e);
                }
            }
        }
    }
    </script>
  </body>
</html>

