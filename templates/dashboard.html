<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>{{ current_symbol }} - è‡ªåŠ¨äºé’±Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'buy': '#059669',      // ä¹°å…¥ç»¿
              'sell': '#dc2626',     // å–å‡ºçº¢
              'cancel': '#94a3b8',   // æ’¤å•ç°
            }
          }
        }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
  </head>
  <body class="bg-gray-50 text-gray-800 font-sans antialiased overflow-x-hidden selection:bg-blue-100">

    <nav class="sticky top-0 z-50 bg-white/95 backdrop-blur shadow-sm border-b border-gray-200">
      <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8"> 
        <div class="flex flex-col md:flex-row justify-between items-center py-3 gap-3">
          <div class="font-bold text-lg tracking-tight text-gray-900 flex items-center justify-between w-full md:w-auto gap-2">
            <span class="flex items-center gap-2">
                ğŸ’¸ <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">è‡ªåŠ¨äºé’±Agent</span>
            </span>
            <div class="flex items-center gap-2">
                <a href="https://github.com/alphaply/crypto-agent" target="_blank" class="text-gray-400 hover:text-gray-900 transition-colors" title="GitHub Repository">
                    <svg viewBox="0 0 24 24" class="h-5 w-5 fill-current"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                </a>
                <button onclick="location.reload()" title="åˆ·æ–°" class="p-1.5 md:hidden text-gray-500 bg-gray-50 border border-gray-200 rounded-lg">â†»</button>
            </div>
          </div>
          <div class="flex w-full md:w-auto items-center gap-2 justify-between md:justify-end">
             <select id="symbolSelect" onchange="window.location.href = '?symbol=' + this.value" class="form-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 outline-none flex-grow md:flex-grow-0 md:w-40">
              {% for sym in symbols %} 
                <option value="{{ sym }}" {% if sym == current_symbol %}selected{% endif %}>{{ sym }}</option>
              {% endfor %}
            </select>
            <div class="flex gap-1.5">
                <div class="inline-flex rounded-md shadow-sm" role="group">
                    <a href="/chat" title="Chat" class="px-2.5 py-2 text-sm font-medium text-teal-700 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100">ğŸ’¬</a>
                    <button onclick="openConfigModal()" title="é…ç½®ç®¡ç†" class="px-2.5 py-2 text-sm font-medium text-indigo-600 bg-white border border-l-0 border-gray-200 hover:bg-gray-100">âš™ï¸</button>
                    <button onclick="openStatsModal()" title="æ¶ˆè€—ç»Ÿè®¡" class="px-2.5 py-2 text-sm font-medium text-amber-600 bg-white border border-l-0 border-gray-200 hover:bg-gray-100">ğŸ“Š</button>
                    <a href="/history?symbol={{ current_symbol }}" title="å†å²å›æº¯" class="px-2.5 py-2 text-sm font-medium text-blue-600 bg-white border border-l-0 border-gray-200 hover:bg-gray-100">ğŸ“œ</a>
                    <button onclick="openDeleteModal()" title="æ¸…é™¤å†å²" class="px-2.5 py-2 text-sm font-medium text-red-600 bg-white border border-l-0 border-gray-200 rounded-r-lg hover:bg-gray-100 hover:text-red-700">ğŸ—‘ï¸</button>
                </div>
                <button onclick="location.reload()" title="åˆ·æ–°" class="hidden md:block p-2 text-gray-500 bg-white border border-gray-200 rounded-lg hover:bg-gray-100">â†»</button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="bg-amber-50 border-b border-amber-200 text-amber-900 text-sm">
      <div class="max-w-[1600px] mx-auto px-4 py-2 sm:px-6 lg:px-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
          <div class="flex flex-wrap items-center gap-x-4 gap-y-1">
            <span class="flex items-center gap-2">
                {% if scheduler_enabled and symbol_enabled %} 
                    <span class="w-2.5 h-2.5 bg-emerald-500 rounded-full animate-pulse-custom"></span> <span class="font-medium">è¿è¡Œä¸­</span>
                {% elif not scheduler_enabled %}
                    <span class="w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse-red"></span> <span class="font-medium text-red-500">è°ƒåº¦å™¨å·²ç¦ç”¨</span>
                {% else %}
                    <span class="w-2.5 h-2.5 bg-amber-500 rounded-full"></span> <span class="font-medium text-amber-600">å·²æš‚åœ (ç¦ç”¨ä¸­)</span>
                {% endif %}
            </span>
            <span class="text-amber-300 hidden sm:inline">|</span>
            <span>æ¨¡å¼: <span class="font-bold text-amber-800">{{ symbol_mode }}</span></span>
            <span class="text-amber-300 hidden sm:inline">|</span>
            <span>é¢‘ç‡: <span class="font-bold text-emerald-700">{{ symbol_freq }}</span></span>
          </div>
          <div>é£æ§ç³»ç»Ÿ: <span class="font-bold text-emerald-600">å·²å¯åŠ¨</span></div>
        </div>
      </div>
    </div>

    <main class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
      
      {% if agent_summaries %}
      <!-- 1. Agent Tab åˆ‡æ¢å™¨ -->
      <div class="flex flex-wrap items-center gap-2 p-1.5 bg-gray-200/50 rounded-2xl w-fit mini-scroll overflow-x-auto max-w-full">
          {% for summary in agent_summaries %}
          <button onclick="switchAgentTab('{{ summary.agent_name }}')" id="tab-btn-{{ summary.agent_name }}" 
                  class="agent-tab-btn flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-bold transition-all whitespace-nowrap
                  {{ 'bg-white shadow-sm text-blue-600' if loop.first else 'text-gray-500 hover:bg-gray-100' }}">
              <span>{{ 'ğŸ”´' if summary.mode == 'REAL' else 'ğŸ”µ' }}</span>
              {{ summary.display_name or summary.agent_name }}
          </button>
          {% endfor %}
          <button onclick="switchAgentTab('COMPARE')" id="tab-btn-COMPARE" class="agent-tab-btn flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-bold text-gray-500 hover:bg-gray-100 transition-all">
              âš–ï¸ å¯¹æ¯”è§†å›¾
          </button>
      </div>

      <!-- 2. Agent è§†çª—å®¹å™¨ -->
      <div id="agent-windows-container" class="relative">
          {% for summary in agent_summaries %}
          <div id="window-{{ summary.agent_name }}" class="agent-window {{ '' if loop.first else 'hidden' }} space-y-6 animate-in fade-in slide-in-from-bottom-2 duration-300">
              
              <!-- Agent å¤´éƒ¨æ¦‚è§ˆå¡ -->
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                  <!-- å·¦ä¾§ï¼šåˆ†ææ­£æ–‡ -->
                  <div class="lg:col-span-2 space-y-6">
                      <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
                          <div class="px-6 py-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
                              <h3 class="font-bold text-gray-900 flex items-center gap-2">
                                  ğŸ“Š å¸‚åœºåˆ†ææŠ¥å‘Š
                                  <span class="text-[10px] font-mono text-gray-400 bg-white px-2 py-1 rounded shadow-sm">{{ summary.timestamp }}</span>
                              </h3>
                              <div class="flex gap-2">
                                  <span class="px-2 py-1 text-[10px] font-bold bg-purple-50 text-purple-600 rounded-lg border border-purple-100">ğŸ§  {{ summary.model }}</span>
                                  <span class="px-2 py-1 text-[10px] font-bold bg-orange-50 text-orange-600 rounded-lg border border-orange-100">âš¡ {{ summary.leverage }}x</span>
                              </div>
                          </div>
                          <div class="p-6">
                              <div class="markdown-content text-gray-700 text-sm leading-relaxed antialiased">{{ summary.content|trim }}</div>
                              
                              <div class="mt-6 bg-blue-50/50 border-l-4 border-blue-500 p-4 rounded-r-xl">
                                  <div class="text-[10px] font-bold uppercase text-blue-400 mb-2 tracking-wider">æ‰§è¡Œç­–ç•¥é€»è¾‘ (Strategy Logic)</div>
                                  <div class="markdown-content text-xs text-blue-900/80 leading-relaxed">{{ summary.strategy_logic|trim }}</div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- å³ä¾§ï¼šä¸“å±æµæ°´è¡¨ -->
                  <div class="lg:col-span-1 space-y-4">
                      <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden flex flex-col h-full">
                          <div class="px-5 py-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
                              <h3 class="font-bold text-gray-900 text-sm flex items-center gap-2">ğŸ“œ ä¸“å±å†³ç­–æµæ°´</h3>
                              <span class="text-[10px] bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full font-bold">{{ summary.all_orders|length }}</span>
                          </div>
                          <div class="flex-grow overflow-y-auto max-h-[600px] mini-scroll p-4 space-y-3">
                              {% if summary.all_orders %}
                                  {% for order in summary.all_orders %}
                                  <div class="group bg-gray-50 hover:bg-white border border-gray-100 hover:border-blue-200 rounded-xl p-3 transition-all">
                                      <div class="flex justify-between items-start mb-2">
                                          <div class="flex items-center gap-2">
                                              {% set s = order.side|lower %}
                                              <span class="px-2 py-0.5 rounded-lg font-black uppercase text-[10px] shadow-sm
                                                  {% if 'buy' in s %} bg-emerald-500 text-white
                                                  {% elif 'sell' in s %} bg-red-500 text-white
                                                  {% elif 'close' in s %} bg-orange-500 text-white
                                                  {% elif 'cancel' in s %} bg-gray-400 text-white
                                                  {% endif %}">
                                                  {{ order.side }}
                                              </span>
                                              <span class="text-xs font-mono font-bold text-gray-700">{{ order.entry_price }}</span>
                                          </div>
                                          <span class="text-[9px] font-mono text-gray-400">{{ order.timestamp[11:16] }}</span>
                                      </div>
                                      <div class="text-[10px] text-gray-500 leading-relaxed line-clamp-2 group-hover:line-clamp-none transition-all">
                                          {{ order.reason }}
                                      </div>
                                      {% if order.take_profit > 0 or order.stop_loss > 0 %}
                                      <div class="mt-2 flex gap-3 text-[9px] font-bold">
                                          <span class="text-emerald-600">ğŸ¯ TP: {{ order.take_profit|int }}</span>
                                          <span class="text-red-500">ğŸ›¡ï¸ SL: {{ order.stop_loss|int }}</span>
                                      </div>
                                      {% endif %}
                                  </div>
                                  {% endfor %}
                              {% else %}
                                  <div class="text-center py-10 text-gray-400 text-xs italic">æš‚æ— æµæ°´æ•°æ®</div>
                              {% endif %}
                          </div>
                      </div>
                  </div>
              </div>
          </div>
          {% endfor %}

          <!-- å¯¹æ¯”è§†å›¾è§†çª— (äº¤äº’æ»‘åŠ¨ç‰ˆ V4) -->
          <div id="window-COMPARE" class="hidden animate-in fade-in slide-in-from-bottom-2 duration-300">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-start">
                  {% for summary in agent_summaries %}
                  <div class="bg-white border border-gray-200 rounded-3xl shadow-lg flex flex-col h-[700px] overflow-hidden border-t-4 {{ 'border-t-rose-500' if summary.mode == 'REAL' else 'border-t-indigo-500' }}">
                      <!-- å¤´éƒ¨ -->
                      <div class="px-6 py-4 border-b border-gray-100 bg-gray-50/30 flex justify-between items-center flex-shrink-0">
                          <div class="min-w-0">
                              <h4 class="font-black text-gray-900 text-sm truncate uppercase tracking-tight">{{ summary.agent_name }}</h4>
                              <div class="flex items-center gap-2 mt-1">
                                  <span class="text-[9px] font-bold px-2 py-0.5 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-sm uppercase">{{ summary.model }}</span>
                                  <span class="text-[9px] font-mono text-gray-400">{{ summary.timestamp[11:16] }}</span>
                              </div>
                          </div>
                          <button onclick="switchAgentTab('{{ summary.agent_name }}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-full transition-colors">
                              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" stroke-width="2.5"/></svg>
                          </button>
                      </div>

                      <!-- å†…éƒ¨ç‹¬ç«‹æ»šåŠ¨åŒºåŸŸ -->
                      <div class="flex-grow overflow-y-auto mini-scroll p-6 space-y-6">
                          <!-- åˆ†ææ­£æ–‡ -->
                          <div class="space-y-3">
                              <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Market Analysis</div>
                              <div class="text-gray-700 text-[13px] leading-relaxed antialiased"><div class="markdown-content">{{ summary.content|trim }}</div></div>
                          </div>
                          
                          <!-- æ‰§è¡Œé€»è¾‘ -->
                          <div class="pt-4 border-t border-gray-100">
                              <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 italic">Core Strategy Logic</div>
                              <div class="bg-blue-50/30 p-4 rounded-2xl border border-blue-100/50">
                                  <div class="markdown-content text-[11px] text-blue-900/80 leading-relaxed">{{ summary.strategy_logic|trim }}</div>
                              </div>
                          </div>

                          <!-- è¿‘æœŸå†³ç­–è®°å½• -->
                          <div class="pt-4 border-t border-gray-100">
                              <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4">Latest 10 Decisions</div>
                              <div class="space-y-3">
                                  {% if summary.all_orders %}
                                      {% for order in summary.all_orders[:10] %}
                                      <div class="flex flex-col gap-1.5 p-3 rounded-xl bg-gray-50 border border-gray-100 group hover:border-blue-200 transition-colors">
                                          <div class="flex items-center justify-between">
                                              <div class="flex items-center gap-2">
                                                  {% set s = order.side|lower %}
                                                  <span class="w-2 h-2 rounded-full 
                                                      {% if 'buy' in s %} bg-emerald-500
                                                      {% elif 'sell' in s %} bg-rose-500
                                                      {% elif 'close' in s %} bg-orange-500
                                                      {% else %} bg-gray-400 {% endif %}"></span>
                                                  <span class="text-[10px] font-black uppercase text-gray-700 w-10">{{ order.side[:4] }}</span>
                                                  <span class="text-[10px] font-mono font-bold text-blue-600 group-hover:text-blue-700">{{ order.entry_price }}</span>
                                              </div>
                                              <div class="text-[9px] text-gray-400 font-mono">{{ order.timestamp[11:16] }}</div>
                                          </div>
                                          
                                          <!-- æ­¢ç›ˆæ­¢æŸ (ç­–ç•¥æ¨¡å¼æ ¸å¿ƒ) -->
                                          {% if order.take_profit > 0 or order.stop_loss > 0 %}
                                          <div class="flex gap-3 text-[9px] font-bold">
                                              <span class="text-emerald-600 flex items-center gap-0.5">ğŸ¯ <span class="opacity-70">TP:</span> {{ order.take_profit|int }}</span>
                                              <span class="text-rose-500 flex items-center gap-0.5">ğŸ›¡ï¸ <span class="opacity-70">SL:</span> {{ order.stop_loss|int }}</span>
                                          </div>
                                          {% endif %}

                                          <!-- ç®€çŸ­ç†ç”± -->
                                          <div class="text-[9px] text-gray-400 leading-tight line-clamp-1 italic">
                                              {{ order.reason }}
                                          </div>
                                      </div>
                                      {% endfor %}
                                  {% else %}
                                      <div class="text-center py-6 text-gray-400 text-[10px] italic">No active data</div>
                                  {% endif %}
                              </div>
                          </div>
                      </div>

                      <!-- åº•éƒ¨æ“ä½œæ  -->
                      <div class="px-6 py-4 bg-gray-50/50 border-t border-gray-100 flex-shrink-0">
                          <a href="/chat?config_id={{ summary.agent_name }}&symbol={{ current_symbol }}" class="w-full inline-flex justify-center items-center gap-2 bg-white border border-gray-200 text-gray-700 py-2.5 rounded-xl font-bold shadow-sm hover:border-blue-500 hover:text-blue-600 transition-all text-[11px]">
                              ğŸ’¬ Open Detailed Chat
                          </a>
                      </div>
                  </div>
                  {% endfor %}
              </div>
          </div>
      </div>
      {% else %}
      <div class="text-center py-24 bg-white rounded-3xl border-2 border-dashed border-gray-200 text-gray-400">
          <div class="text-5xl mb-4">ğŸ’¤</div>
          <p class="text-lg font-medium">å½“å‰å¸ç§æ²¡æœ‰ä»»ä½• Agent åˆ†ææ•°æ®</p>
          <p class="text-sm mt-2">è¯·æ£€æŸ¥é…ç½®ä¸­å¿ƒæ˜¯å¦å·²å¯ç”¨å¯¹åº”çš„äº¤æ˜“å¯¹</p>
      </div>
      {% endif %}

    </main>

    <div id="delete-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity" onclick="closeDeleteModal()"></div>

        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-gray-200">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                                <h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">é‡ç½®äº¤æ˜“æ•°æ®</h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-500">
                                        æ‚¨ç¡®å®šè¦æ¸…ç©º <span class="font-bold text-gray-800">{{ current_symbol }}</span> çš„æ‰€æœ‰åˆ†æå†å²ã€<b>å†³ç­–æµæ°´</b>åŠæŒ‚å•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚
                                    </p>
                                    <div class="mt-4">
                                        <label for="admin-pass" class="block text-xs font-medium text-gray-700 mb-1">ç®¡ç†å‘˜å¯†ç </label>
                                        <input type="password" id="admin-pass" class="w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm p-2 border" placeholder="è¯·è¾“å…¥å¯†ç ä»¥ç¡®è®¤...">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                        <button type="button" onclick="confirmDeleteAction()" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto transition-colors">ç¡®è®¤æ¸…ç©º</button>
                        <button type="button" onclick="closeDeleteModal()" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto transition-colors">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é…ç½®ä¸­å¿ƒæ¨¡æ€æ¡† -->
    <div id="config-modal" class="fixed inset-0 z-[100] hidden modal-container">
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm" onclick="closeConfigModal()"></div>
        <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden border border-gray-200 modal-content">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 flex-shrink-0">
                    <div class="flex items-center gap-4">
                        <h3 class="text-lg font-bold text-gray-900">âš™ï¸ é…ç½®ä¸­å¿ƒ</h3>
                        <div class="flex bg-gray-200 p-1 rounded-lg text-[10px] font-bold uppercase">
                            <button onclick="switchConfigTab('list')" id="tab-btn-list" class="px-3 py-1 rounded-md bg-white shadow-sm text-blue-600">åˆ—è¡¨æ¨¡å¼</button>
                            <button onclick="switchConfigTab('prompt')" id="tab-btn-prompt" class="px-3 py-1 rounded-md text-gray-500">Prompt æ¨¡æ¿</button>
                            <button onclick="switchConfigTab('raw')" id="tab-btn-raw" class="px-3 py-1 rounded-md text-gray-500">JSON æ¨¡å¼</button>
                        </div>
                    </div>
                    <button onclick="closeConfigModal()" class="text-gray-400 hover:text-gray-600 text-2xl p-2">&times;</button>
                </div>
                
                <div class="p-4 sm:p-6 overflow-y-auto modal-scroll-area mini-scroll">
                    <!-- åˆ—è¡¨æ¨¡å¼è§†å›¾ -->
                    <div id="config-view-list" class="space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <label class="block text-xs font-bold text-blue-500 uppercase mb-2">å…¨å±€è¿è¡Œæ§åˆ¶</label>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-blue-900">æ™ºèƒ½è°ƒåº¦å™¨çŠ¶æ€</span>
                                    <label class="switch">
                                        <input type="checkbox" id="global-scheduler">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">é»˜è®¤äº¤æ˜“æ æ†</label>
                                <div class="flex items-center gap-3">
                                    <input type="number" id="global-leverage" class="w-20 border rounded p-1.5 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                    <span class="text-xs text-gray-400">ä»…ç”¨äº Prompt æç¤º</span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                    ğŸš€ äº¤æ˜“å¯¹é…ç½®
                                    <span id="config-count-badge" class="bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full text-[10px]">0</span>
                                </h4>
                                <button onclick="addNewSymbolConfig()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 transition-all">
                                    <span>+</span> æ·»åŠ æ–°å¸ç§
                                </button>
                            </div>
                            <div id="symbol-config-list" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <!-- å¡ç‰‡ç”± JS åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>

                    <!-- Prompt æ¨¡æ¿è§†å›¾ -->
                    <div id="config-view-prompt" class="hidden flex flex-col md:flex-row gap-4 h-[600px]">
                        <div class="w-full md:w-48 flex flex-col gap-2 bg-gray-50 p-2 rounded-xl border border-gray-200 overflow-y-auto mini-scroll flex-shrink-0">
                            <div class="flex justify-between items-center px-2 py-1">
                                <span class="text-[10px] font-bold text-gray-400 uppercase">æ–‡ä»¶åˆ—è¡¨</span>
                                <button onclick="createNewPrompt()" class="text-blue-600 hover:text-blue-800" title="æ–°å»º Prompt">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 4v16m8-8H4" stroke-width="2"/></svg>
                                </button>
                            </div>
                            <div id="prompt-file-list" class="flex flex-col gap-1">
                                <!-- ç”± JS æ¸²æŸ“ -->
                            </div>
                        </div>
                        <div class="flex-grow flex flex-col gap-2 overflow-hidden">
                            <div class="flex justify-between items-center px-1">
                                <span id="current-prompt-name" class="text-xs font-mono font-bold text-blue-600">æœªé€‰æ‹©æ–‡ä»¶</span>
                                <div class="flex gap-2">
                                    <button onclick="saveCurrentPrompt()" class="text-[10px] bg-emerald-600 text-white px-3 py-1 rounded-md font-bold shadow-sm">ä¿å­˜æ–‡ä»¶</button>
                                    <button onclick="deleteCurrentPrompt()" id="btn-delete-prompt" class="hidden text-[10px] bg-red-100 text-red-600 px-3 py-1 rounded-md font-bold">åˆ é™¤</button>
                                </div>
                            </div>
                            <textarea id="prompt-editor" class="w-full flex-grow font-mono text-[11px] border rounded-xl p-4 bg-white focus:ring-2 focus:ring-blue-500 outline-none leading-relaxed mini-scroll" spellcheck="false" placeholder="ç‚¹å‡»å·¦ä¾§æ–‡ä»¶å¼€å§‹ç¼–è¾‘..."></textarea>
                        </div>
                    </div>

                    <!-- JSON æ¨¡å¼è§†å›¾ -->
                    <div id="config-view-raw" class="hidden space-y-4">
                        <div class="flex justify-between items-center">
                            <p class="text-[11px] text-gray-400">ç›´æ¥ä¿®æ”¹åº•å±‚çš„ SYMBOL_CONFIGS JSON å­—ç¬¦ä¸²ã€‚</p>
                            <div class="flex gap-2">
                                <button onclick="formatConfigJson()" class="text-xs text-blue-600 font-bold">æ ¼å¼åŒ–</button>
                                <a href="/api/config/export" class="text-xs text-green-600 font-bold">å¯¼å‡ºå¤‡ä»½</a>
                            </div>
                        </div>
                        <textarea id="config-json" class="w-full h-[500px] font-mono text-[11px] border rounded-xl p-4 bg-gray-50 focus:bg-white transition-colors outline-none focus:ring-2 focus:ring-blue-500 leading-relaxed" spellcheck="false"></textarea>
                    </div>
                </div>

                <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-3 flex-shrink-0">
                    <div class="text-[10px] text-gray-400 text-center sm:text-left leading-tight">âš ï¸ ä¿å­˜å .env å°†å®æ—¶æ›´æ–°å¹¶è§¦å‘çƒ­é‡è½½</div>
                    <div class="flex gap-3 w-full sm:w-auto">
                        <button onclick="closeConfigModal()" class="flex-1 sm:flex-none px-6 py-2.5 rounded-lg text-sm font-bold text-gray-500 bg-white border border-gray-200">å–æ¶ˆ</button>
                        <button onclick="saveConfigFromUI()" class="flex-1 sm:flex-none bg-blue-600 hover:bg-blue-700 text-white px-8 py-2.5 rounded-lg text-sm font-bold transition-all shadow-md active:scale-95">ä¿å­˜å¹¶åº”ç”¨</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¸ç§ç¼–è¾‘è¡¨å• (ç‹¬ç«‹çš„å°æ¨¡æ€æ¡†) -->
    <div id="symbol-edit-modal" class="fixed inset-0 z-[120] hidden modal-container">
        <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm" onclick="closeSymbolEditModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border border-gray-200 modal-content h-auto !max-h-[90vh]">
                <div class="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
                    <h4 id="symbol-modal-title" class="font-bold text-gray-900">ç¼–è¾‘äº¤æ˜“å¯¹</h4>
                    <button onclick="closeSymbolEditModal()" class="text-gray-400 text-2xl">&times;</button>
                </div>
                <div class="p-6 space-y-6 overflow-y-auto max-h-[70vh] mini-scroll">
                    <input type="hidden" id="edit-config-index">
                    
                    <!-- 1. æ ¸å¿ƒäº¤æ˜“é…ç½® -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-1 h-4 bg-blue-600 rounded-full"></span>
                            <h5 class="text-xs font-bold text-gray-900 uppercase">æ ¸å¿ƒäº¤æ˜“é…ç½®</h5>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">é…ç½® ID</label>
                                <input type="text" id="edit-config-id" class="w-full border rounded-lg p-2 text-xs bg-gray-50 font-mono" readonly>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">äº¤æ˜“å¯¹ (Symbol)</label>
                                <input type="text" id="edit-symbol" class="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="BTC/USDT">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">è¿è¡Œæ¨¡å¼</label>
                                <select id="edit-mode" class="w-full border rounded-lg p-2 text-sm">
                                    <option value="STRATEGY">æ¨¡æ‹Ÿ (STRATEGY)</option>
                                    <option value="REAL">å®ç›˜ (REAL)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Prompt æ¨¡æ¿</label>
                                <select id="edit-prompt-file" class="w-full border rounded-lg p-2 text-sm"></select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">æ æ†å€æ•°</label>
                                <input type="number" id="edit-leverage" class="w-full border rounded-lg p-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">LLM æ¸©åº¦</label>
                                <input type="number" step="0.1" id="edit-temp" class="w-full border rounded-lg p-2 text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- 2. ä¸»å†³ç­–æ¨¡å‹é…ç½® -->
                    <div class="space-y-4 pt-4 border-t border-gray-100">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-1 h-4 bg-purple-600 rounded-full"></span>
                            <h5 class="text-xs font-bold text-gray-900 uppercase">å†³ç­–æ¨¡å‹ (LLM)</h5>
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">æ¨¡å‹åç§°</label>
                                <input type="text" id="edit-model" class="w-full border rounded-lg p-2 text-sm" placeholder="gpt-4o">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">API Base URL</label>
                                <input type="text" id="edit-api-base" class="w-full border rounded-lg p-2 text-sm" placeholder="https://api.openai.com/v1">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">API Key</label>
                                <input type="password" id="edit-api-key" class="w-full border rounded-lg p-2 text-sm" placeholder="ä¿æŒä¸å˜è¯·ç•™ç©º...">
                            </div>
                        </div>
                    </div>

                    <!-- 3. å¸å®‰ä¸“å± API (å¯é€‰) -->
                    <div class="space-y-4 pt-4 border-t border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="w-1 h-4 bg-amber-500 rounded-full"></span>
                                <h5 class="text-xs font-bold text-gray-900 uppercase">å¸å®‰ä¸“å± API (å¯é€‰)</h5>
                            </div>
                            <span class="text-[9px] text-gray-400 italic">ä¸å¡«åˆ™ä½¿ç”¨å…¨å±€é…ç½®</span>
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            <input type="password" id="edit-bn-key" class="w-full border rounded-lg p-2 text-xs" placeholder="Binance API Key">
                            <input type="password" id="edit-bn-secret" class="w-full border rounded-lg p-2 text-xs" placeholder="Binance API Secret">
                        </div>
                    </div>

                    <!-- 4. æ€»ç»“æ¨¡å‹é…ç½® (Summarizer) -->
                    <div class="space-y-4 pt-4 border-t border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="w-1 h-4 bg-emerald-500 rounded-full"></span>
                                <h5 class="text-xs font-bold text-gray-900 uppercase">æ€»ç»“æ¨¡å‹ (Summarizer)</h5>
                            </div>
                            <label class="flex items-center gap-1 cursor-pointer">
                                <input type="checkbox" id="enable-sum-cfg" onchange="toggleSumSection(this.checked)" class="w-3 h-3">
                                <span class="text-[10px] text-gray-500 font-bold">å¯ç”¨ä¸“å±é…ç½®</span>
                            </label>
                        </div>
                        <div id="sum-section" class="grid grid-cols-1 gap-3 opacity-40 pointer-events-none transition-opacity">
                            <input type="text" id="edit-sum-model" class="w-full border rounded-lg p-2 text-xs" placeholder="æ€»ç»“æ¨¡å‹åç§° (å¦‚ gpt-4o-mini)">
                            <input type="text" id="edit-sum-base" class="w-full border rounded-lg p-2 text-xs" placeholder="Summarizer API Base">
                            <input type="password" id="edit-sum-key" class="w-full border rounded-lg p-2 text-xs" placeholder="Summarizer API Key">
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 border-t flex gap-3">
                    <button onclick="applySymbolEdit()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold shadow-sm">ç¡®å®š</button>
                    <button onclick="closeSymbolEditModal()" class="flex-1 bg-white border text-gray-500 py-2 rounded-lg font-bold">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡ä¸­å¿ƒæ¨¡æ€æ¡† -->
    <div id="stats-modal" class="fixed inset-0 z-[100] hidden modal-container">
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm" onclick="closeStatsModal()"></div>
        <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col overflow-hidden border border-gray-200 modal-content">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 flex-shrink-0">
                    <h3 class="text-lg font-bold text-gray-900">ğŸ“Š èµ„æºæ¶ˆè€—ç»Ÿè®¡</h3>
                    <button onclick="closeStatsModal()" class="text-gray-400 hover:text-gray-600 text-2xl p-2">&times;</button>
                </div>
                <div id="stats-content" class="p-4 sm:p-6 overflow-y-auto mini-scroll modal-scroll-area">
                    <div class="animate-pulse flex space-y-4 flex-col">
                        <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆæƒæ¨¡æ€æ¡† -->
    <div id="auth-modal" class="fixed inset-0 z-[110] hidden modal-container">
        <div class="fixed inset-0 bg-gray-900/80 backdrop-blur-md"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 border border-gray-200 modal-content h-auto !max-h-fit !rounded-xl">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">ğŸ” èº«ä»½éªŒè¯</h3>
                <p class="text-sm text-gray-500 mb-4">è®¿é—®æ•æ„ŸåŠŸèƒ½éœ€è¦ç®¡ç†å‘˜æƒé™ã€‚</p>
                <input type="password" id="auth-pass" class="w-full border rounded-lg p-3 mb-3 outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥å¯†ç ...">
                
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-gray-100 rounded-lg overflow-hidden cursor-pointer flex-shrink-0" onclick="refreshCaptcha()" title="ç‚¹å‡»åˆ·æ–°">
                        <img id="captcha-img" class="w-[120px] h-[40px] block" alt="éªŒè¯ç ">
                    </div>
                    <input type="text" id="auth-captcha" class="flex-1 border rounded-lg p-2 h-[40px] outline-none focus:ring-2 focus:ring-blue-500 text-center font-bold uppercase" placeholder="éªŒè¯ç ">
                </div>

                <div class="flex gap-3">
                    <button onclick="submitAuth()" class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg font-bold shadow-sm active:scale-95 transition-all">ç¡®è®¤</button>
                    <button onclick="closeAuthModal()" class="flex-1 bg-gray-100 text-gray-600 py-2.5 rounded-lg font-bold">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-4 right-4 z-[200] flex flex-col gap-2 pointer-events-none"></div>

    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
  </body>
</html>
