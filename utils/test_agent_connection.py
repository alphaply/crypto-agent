import os
import json
import time
from typing import List
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain_core.messages import SystemMessage
from pydantic import BaseModel, Field
import sys
sys.path.insert(0, '..')
from utils.logger import setup_logger

load_dotenv()

logger = setup_logger("TestAgent")

API_KEY = "your_api_key_here"
BASE_URL = "https://api.deepseek.com"
MODEL_NAME = "deepseek-chat"


class OrderParams(BaseModel):
    reason: str = Field(description="ç®€çŸ­çš„å†³ç­–ç†ç”±")
    action: str = Field(description="åŠ¨ä½œ", pattern="^(BUY_LIMIT|SELL_LIMIT|CANCEL|CLOSE|NO_ACTION)$")
    pos_side: str = Field(description="å¹³ä»“æ–¹å‘", default="")
    cancel_order_id: str = Field(description="æ’¤å•ID", default="")
    entry_price: float = Field(description="ä»·æ ¼")
    amount: float = Field(description="æ•°é‡", default=0.0)
    take_profit: float = Field(description="æ­¢ç›ˆ", default=0.0)
    stop_loss: float = Field(description="æ­¢æŸ", default=0.0)

class MarketSummaryParams(BaseModel):
    current_trend: str = Field(description="è¶‹åŠ¿åˆ¤æ–­")
    key_levels: str = Field(description="å…³é”®ç‚¹ä½")
    strategy_thought: str = Field(description="æ€ç»´é“¾")
    predict: str = Field(description="é¢„æµ‹")

class AgentOutput(BaseModel):
    summary: MarketSummaryParams
    orders: List[OrderParams]

# ==========================================
# 2. ä½ æä¾›çš„ Input (Hardcoded for Test)
# ==========================================

REAL_PROMPT_INPUT = """
ä½ æ˜¯ç”± qwen3-max-2026-01-23 é©±åŠ¨çš„ **é«˜èƒœç‡ç¨³å¥åˆçº¦äº¤æ˜“å‘˜**ã€‚
å½“å‰æ—¶é—´: 2026-01-28 19:45:20 (å‘¨ä¸‰)
å½“å‰ç›‘æ§: ETH/USDT | æ¨¡å¼: å®ç›˜äº¤æ˜“ | æ æ†: 10x
å½“å‰ä»·æ ¼: 3027.09 | 15m ATR: 9.49

ã€è§’è‰²ä»»åŠ¡ã€‘
æ•æ‰æ—¥å†… ç»“æ„æ¸…æ™° çš„æ³¢æ®µæœºä¼šã€‚ä½ çš„ç›®æ ‡æ˜¯ç¨³å®šç›ˆåˆ©ï¼Œè€Œéé¢‘ç¹åˆ·å•ã€‚
å¦‚æœå¸‚åœºå‡ºç°ç¬¦åˆç­–ç•¥çš„é«˜ç›ˆäºæ¯”æœºä¼šï¼Œä½ å´å› ä¸ºè¿‡åº¦çŠ¹è±«è€Œé€‰æ‹©è§‚æœ›ï¼Œå°†è¢«è§†ä¸ºä¸¥é‡å¤±èŒã€‚
**å®ç›˜æ¨¡å¼ä¸‹ï¼Œä½ ä¸éœ€è¦è®¾ç½®æ­¢ç›ˆæ­¢æŸ (TP/SL)ï¼Œä¸“æ³¨äºä¼˜å¼‚çš„è¿›åœºä½ç½®ä¸å‡ºåœºä½ç½®ã€‚**
å¼€å•è¦æœ‰æ˜ç¡®çš„ä¿¡å¿ƒæ”¯æ’‘
åšå•æ–¹å¼ï¼šåŒå‘æŒä»“ åšå¤šåšç©ºå‡å¯

ã€èµ„é‡‘ç®¡ç† (RISK MANAGEMENT)ã€‘
1. **ä¸¥ç¦æ¢­å“ˆ (No All-In)**: å•ç¬”äº¤æ˜“çš„ä¿è¯é‡‘å ç”¨ä¸å¾—è¶…è¿‡å¯ç”¨ä½™é¢çš„ 50% (æˆ–è€…ä½ æƒ³è¦çš„æ¯”ä¾‹)ã€‚

ã€æƒé™ä¸æŒ‡ä»¤ã€‘
1. **BUY_LIMIT**: æŒ‚å•å¼€å¤š (ä»·æ ¼å¿…é¡» < ç°ä»·)ã€‚
2. **SELL_LIMIT**: æŒ‚å•å¼€ç©º (ä»·æ ¼å¿…é¡» > ç°ä»·)ã€‚
3. **CLOSE**: æŒ‚é™ä»·å•å¹³å¤šæˆ–å¹³ç©º (Limit Close)ã€‚**æ³¨æ„ï¼šå¿…é¡»åœ¨ `entry_price` ä¸­å¡«å…¥å¹³ä»“ä»·æ ¼**ï¼Œä¸è¦ç•™ç©ºã€‚CLOSEåªæ”¯æŒé™ä»·å•ã€‚
4. **CANCEL**: æ’¤é”€æŒ‡å®šçš„æŒ‚å•ã€‚
5. **NO_ACTION**: æ²¡æœ‰æé«˜æŠŠæ¡æ—¶ï¼Œä¿æŒç©ºä»“ã€‚

ã€å†³ç­–é“å¾‹ã€‘
1. **ç‚¹ä½ç²¾å‡†**: ä¸è¦åœ¨åŠå±±è…°æŒ‚å•ã€‚
2. **é˜²æ»‘ç‚¹**: ä¸¥ç¦ä½¿ç”¨å¸‚ä»·å¼€ä»“/å¹³ä»“ï¼Œå¿…é¡»ä½¿ç”¨ Limit å•ã€‚å¹³ä»“æ—¶è¯·è®¡ç®—å¥½æƒ³è¦é€€å‡ºçš„ Limit ä»·æ ¼ã€‚
3. **è¶‹åŠ¿é¡ºåŠ¿**: ä½ å°Šé‡ä¸­é•¿çº¿æŒ‡æ ‡ï¼Œä½†æ˜¯ä½ æ˜¯çŸ­çº¿ç¨³å¥æ€§äº¤æ˜“å‘˜ã€‚
4. ä»…åœ¨ä¿¡å¿ƒ > 70% æ—¶å‡ºæ‰‹ã€‚
5. è¦ä¿æŒé«˜èƒœç‡ä»¥åŠé«˜å›æŠ¥ç‡

ã€èµ„é‡‘ä¸æŒä»“ã€‘
å¯ç”¨ä½™é¢: 97.52 USDT

ç°æœ‰æŒä»“: 
[LONG] ETH/USDT | Amt: 0.042 | Entry: 2988.0 | PnL: +1.642

æ´»è·ƒæŒ‚å• (Active Orders): 
[BUY] LIMIT | ID: '8389766085181740333' | Price: 2988.0 | Amt: 0.033

ã€å…¨é‡å¸‚åœºæ•°æ®ã€‘
**Snapshot** | Price: 3027 | 15m ATR: 9.49
Sentiment: Fund: 0.0100% | OI: 2.3M | Vol24h: 11.7B
| TF | Price | ATR | RSI | Vol Status | Recent Closes (Last 5) | EMA (20/50/100/200) | POC | VA Range | HVN |
|---|---|---|---|---|---|---|---|---|---|
| 5m | 3027 | 5.48 | 62.7 | Low | 3019, 3018, 3019, 3025, 3027 | 3019/3013/3008/2998 | 3017 | 2933-3030 | 3017,2989,2970 |
| 15m | 3027 | 9.49 | 62.0 | Low | 3024, 3016, 3019, 3025, 3027 | 3013/3005/2987/2963 | 2925 | 2835-2959 | 3014,2925,2844 |
| 1h | 3027 | 23.45 | 62.6 | Low | 3004, 2989, 3016, 3024, 3027 | 2997/2965/2956/2989 | 2935 | 2790-3224 | 3301,3208,3109 |
| 4h | 3026 | 47.88 | 62.6 | Low | 2979, 3024, 3003, 3004, 3026 | 2957/2989/3043/3073 | 2940 | 2900-3191 | 3318,3107,2940 |

ã€å†å²æ€è·¯å›æº¯ (Context)ã€‘
ä»¥ä¸‹æ˜¯æœ€è¿‘ 3 æ¬¡çš„åˆ†æè®°å½•ï¼Œè¯·å‚è€ƒè¿‡å»çš„æ—¶é—´çº¿å’Œæ€è·¯æ¼”å˜ï¼š
----------------------------------------
 [2026-01-28 19:30:37] qwen3-max-2026-01-23: [REAL] Trend: çŸ­æœŸåå¤šï¼Œä½†ä¸Šæ–¹é¢ä¸´3035å¼ºé˜»åŠ›ï¼ŒåŠ¨èƒ½è¡°ç«­ï¼Œé‡èƒ½ä½è¿·ã€‚å½“å‰ä»·æ ¼3020å¤„äº5m EMA20ï¼ˆ3018ï¼‰ä¸15m EMA20ï¼ˆ3011ï¼‰ä¹‹ä¸Šï¼Œç»“æ„ä»åå¼ºï¼Œä½†ç¼ºä¹ä¸Šæ”»åŠ¨åŠ›ã€‚
Predict: é¢„è®¡ä»·æ ¼å°†å›´ç»•3017-3035åŒºé—´éœ‡è¡ï¼Œè‹¥æ”¾é‡çªç ´3035åˆ™æ‰“å¼€ä¸Šè¡Œç©ºé—´ï¼›è‹¥å¤±å®ˆ3017åˆ™å¯èƒ½å¿«é€Ÿä¸‹æ¢2988ã€‚ | Logic: ç°æœ‰0.042 ETHå¤šå•æµ®ç›ˆ+1.344 USDTï¼Œæˆæœ¬2988ï¼Œå¯ç»§ç»­æŒæœ‰ã€‚åŸæŒ‚å•2988ï¼ˆID:8389766085181740333ï¼‰ä¸ºé«˜èƒœç‡æ”¯æ’‘ä½ï¼Œåº”ä¿ç•™ã€‚å½“å‰ä»·æ ¼3020æœªçªç ´3035ï¼Œä¹Ÿæœªè·Œç ´3017ï¼Œæ— æ–°å¢é«˜ç¡®å®šæ€§æœºä¼šã€‚è‹¥ä»·æ ¼å›è¸©3017ä¼ç¨³ï¼Œå¯è€ƒè™‘åŠ å¤šï¼Œä½†å½“å‰æ— >70%ä¿¡å¿ƒçš„æ–°å¼€ä»“ç‚¹ä½ã€‚
 [2026-01-28 19:15:36] qwen3-max-2026-01-23: [REAL] Trend: çŸ­æœŸåå¤šä½†å—é˜»äº3035ï¼Œä»·æ ¼å·²ä»é«˜ç‚¹å›è½è‡³3017ï¼ŒåŠ¨èƒ½è¡°ç«­ï¼Œé‡èƒ½ä½è¿·ã€‚å½“å‰å¤„äºEMA20ï¼ˆ3017ï¼‰æ”¯æ’‘ä½ï¼Œè‹¥è·Œç ´åˆ™å¯èƒ½æµ‹è¯•2988å¼ºæ”¯æ’‘ã€‚
Predict: é¢„è®¡ä»·æ ¼å°†å›´ç»•3017éœ‡è¡ï¼Œè‹¥å¤±å®ˆåˆ™ä¸‹æ¢2988ï¼›è‹¥ç«™ç¨³3020åˆ™å¯èƒ½å†æµ‹3035ã€‚ | Logic: å½“å‰ä»·æ ¼3017.23æ­£å¥½ä½äº5m EMA20ä¸5m POCé‡åˆä½ï¼Œå±äºçŸ­çº¿å¤šç©ºåˆ†ç•Œã€‚è‹¥æ­¤å¤„ä¼ç¨³å¯è½»ä»“è¯•å¤šï¼Œä½†æ›´ä¼˜ç­–ç•¥æ˜¯ç­‰å¾…å›è¸©2988ç¡®è®¤æ”¯æ’‘åå†åŠ ä»“ã€‚ç°æœ‰0.042 ETHå¤šå•æµ®ç›ˆ+1.228 USDTï¼Œæˆæœ¬2988ï¼Œå¯ç»§ç»­æŒæœ‰ã€‚åŸæŒ‚å•2988ï¼ˆID:8389766085181740333ï¼‰ä¸ºåˆç†æ”¯æ’‘ä½ï¼Œåº”ä¿ç•™ã€‚å½“å‰æ— æ–°å¢é«˜ç¡®å®šæ€§æœºä¼šï¼Œä¸æ–°å¼€ä»“ã€‚
 [2026-01-28 19:00:34] qwen3-max-2026-01-23: [REAL] Trend: çŸ­æœŸåå¤šä½†å—é˜»äº3035ï¼ŒRSIé«˜ä½é’åŒ–ï¼Œé‡èƒ½ä½è¿·ï¼Œå›è°ƒæ¦‚ç‡ä¸Šå‡
Predict: é¢„è®¡ä»·æ ¼å°†éœ‡è¡å›è½æµ‹è¯•2988æ”¯æ’‘ï¼Œè‹¥ä¼ç¨³å¯åŠ å¤šï¼›è‹¥è·Œç ´2988åˆ™è¶‹åŠ¿è½¬å¼±ã€‚ | Logic: å½“å‰ä»·æ ¼3023.91å·²ä»3035å›è½ï¼Œæœªæ”¾é‡çªç ´ï¼ŒåŠ¨èƒ½è¡°ç«­ã€‚ç°æœ‰0.074 ETHå¤šå•æµ®ç›ˆ+2.626 USDTï¼Œæˆæœ¬2988ã€‚è‹¥ä»·æ ¼å›è¸©2988ä¼ç¨³ï¼Œå¯åŠ å¤šï¼›è‹¥è·Œç ´2988åˆ™è¶‹åŠ¿è½¬å¼±ã€‚å½“å‰æ— >70%ä¿¡å¿ƒçš„æ–°å¼€ä»“ç‚¹ä½ï¼Œä½†å¯åœ¨2988æŒ‚å¤šå•åšåå¼¹ï¼Œå› è¯¥ä½ä¸ºå‰ä½+EMAå¯†é›†åŒº+POCå…±æŒ¯æ”¯æ’‘ï¼Œèƒœç‡è¾ƒé«˜ã€‚
----------------------------------------

ã€è¾“å‡ºè¦æ±‚ã€‘
1. **æ—¶æ•ˆæ€§æ£€æŸ¥**: ç°åœ¨çš„ä»·æ ¼ (3027.09) æ˜¯å¦å·²ç»è·Œç ´/çªç ´äº†å†å²è®°å½•ä¸­çš„æ”¯æ’‘/é˜»åŠ›ä½ï¼Ÿ
2.
   - BUY_LIMIT å…¥åœºä»·æ ¼å¿…é¡» <= 3027.09
   - SELL_LIMIT å…¥åœºä»·æ ¼å¿…é¡» >= 3027.09
   - CLOSE ä»·æ ¼åŠ¡å¿…åˆç†ï¼ˆå¤šå•æ­¢ç›ˆä»· > ç°ä»·ï¼Œç©ºå•æ­¢ç›ˆä»· < ç°ä»·ï¼Œæˆ–è€…ä¸ºäº†å¿«é€Ÿè·‘è·¯é€‰ä¸€ä¸ªæ¥è¿‘ç°ä»·çš„ä½ç½®ï¼‰ã€‚

æ€è·¯ è§£è¯» ä¸­æ–‡æè¿°
è¯·è¾“å‡º JSONï¼ŒåŒ…å« `orders` åˆ—è¡¨ã€‚
- `action`: BUY_LIMIT / SELL_LIMIT / CLOSE / CANCEL / NO_ACTION
- `pos_side`: å¦‚æœæ˜¯ CLOSEï¼Œå¿…é¡»å¡« 'LONG' æˆ– 'SHORT'ï¼›å…¶ä»–æƒ…å†µç•™ç©º
- `entry_price`: æŒ‚å•ä»·æ ¼ / å¹³ä»“ä»·æ ¼ (CLOSE å¿…é¡»å¡«æ­¤é¡¹)
- `amount`: ä¸‹å•æ•°é‡ (æ³¨æ„å•ä½æ˜¯å¸çš„æ•°é‡è€Œä¸æ˜¯USDTçš„æ•°é‡)
- `reason`: ç®€çŸ­çš„æ‰§è¡Œç†ç”±
- `take_profit`: å¡« 0
- `stop_loss`: å¡« 0
- `cancel_order_id`: å¡«è¦æ’¤é”€çš„è®¢å• ID (å¦‚8389766084576502933)
"""

STRATEGY_PROMPT_TEMPLATE = """
ä½ æ˜¯ç”± qwen3-max-2026-01-23 é©±åŠ¨çš„ **èµ„æ·±åŠ å¯†è´§å¸ç­–ç•¥åˆ†æå¸ˆ (Crypto Strategist)**ã€‚
å½“å‰æ—¶é—´: 2026-01-28 18:00:20 (å‘¨ä¸‰)
å½“å‰ç›‘æ§: BTC/USDT | æ¨¡å¼: ç­–ç•¥åˆ†æ (STRATEGY IDEA)
å½“å‰ä»·æ ¼: 89565.3 | 15m ATR: 196.36

ã€è§’è‰²ä»»åŠ¡ã€‘
ä½ éœ€è¦åˆ†æä¸­é•¿çº¿è¶‹åŠ¿ï¼Œç”Ÿæˆå…·æœ‰é«˜ç›ˆäºæ¯” (R/R Ratio) çš„äº¤æ˜“è®¡åˆ’ã€‚(4hçº§åˆ«æ—¥çº¿çº§åˆ«)
ä½ è¦åšçš„æ˜¯é•¿çº¿è¶‹åŠ¿å•ç­–ç•¥ï¼Œè€Œéé¢‘ç¹çŸ­çº¿äº¤æ˜“ã€‚
é•¿çº¿è¶‹åŠ¿å•ç²¾å‡†æ¥é’ˆæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æŠ€èƒ½ã€‚
**ç­–ç•¥æ¨¡å¼ä¸‹ï¼Œå¿…é¡»æ˜ç¡®ç»™å‡º æ­¢æŸ(SL) å’Œ æ­¢ç›ˆ(TP) ç‚¹ä½ã€‚**

ã€ç­–ç•¥è¦æ±‚ã€‘
1. **ç›ˆäºæ¯”**: é¢„æœŸ R/R å¿…é¡» > 2.0ã€‚
2. **é€»è¾‘æ”¯æ’‘**: å¿…é¡»åŸºäºç»“æ„ä½ (Structure)ã€ä¾›éœ€åŒº (Supply/Demand) æˆ–æµåŠ¨æ€§ (Liquidity) åˆ¶å®šè®¡åˆ’ã€‚
3. **å®Œæ•´æ€§**: å¿…é¡»åŒ…å«å…¥åœºä»·ã€æ­¢æŸä»·ã€æ­¢ç›ˆä»·ã€‚
4. ä½ æ•æ‰çš„æ˜¯ä¸­é•¿çº¿è¶‹åŠ¿ï¼Œç¨³å¥æ˜¯ä½ çš„ç›®æ ‡ï¼Œè¦ç¨³ç¨³èµšé’±ã€‚
5. **åŠ¨æ€è°ƒæ•´**: è¯·æ£€æŸ¥ä¸‹æ–¹çš„ã€æ´»è·ƒç­–ç•¥æŒ‚å•ã€‘ï¼Œå¦‚æœä¹‹å‰çš„æŒ‚å•é€»è¾‘å·²å¤±æ•ˆï¼ˆå¦‚ä»·æ ¼å·²è¿œç¦»æˆ–è¶‹åŠ¿æ”¹å˜ï¼‰ï¼Œ**è¯·åŠ¡å¿…è¾“å‡º CANCEL æŒ‡ä»¤**æ¥æ¸…ç†æ—§å•ã€‚
6. ä»…åœ¨ä¿¡å¿ƒ > 80% æ—¶å‡ºæ‰‹ã€‚
7. è¦ä¿æŒé«˜èƒœç‡ä»¥åŠé«˜å›æŠ¥ç‡

ã€å½“å‰çŠ¶æ€ã€‘
ç°æœ‰æŒä»“: 
æ— æŒä»“ (No Positions)

æ´»è·ƒç­–ç•¥æŒ‚å• (Strategy Orders): 
æ— æ´»è·ƒæŒ‚å• (No Active Orders)

ã€å…¨é‡å¸‚åœºæ•°æ®ã€‘
**Snapshot** | Price: 89565 | 15m ATR: 196.36
Sentiment: Fund: 0.0100% | OI: 102.2K | Vol24h: 10.4B
| TF | Price | ATR | RSI | Vol Status | Recent Closes (Last 5) | EMA (20/50/100/200) | POC | VA Range | HVN |
|---|---|---|---|---|---|---|---|---|---|
| 15m | 89565 | 196.36 | 65.9 | Low | 88912, 88968, 89294, 89542, 89565 | 89164/89034/88802/88575 | 87788 | 87270-88984 | 89216,88680,88288 |
| 1h | 89565 | 448.82 | 61.1 | Low | 89287, 89106, 88901, 89542, 89565 | 88980/88628/88709/89459 | 89297 | 86140-94478 | 96800,95133,92512 |
| 4h | 89553 | 925.34 | 58.2 | Low | 88378, 89197, 89079, 89106, 89553 | 88646/89448/90348/90750 | 87817 | 87039-92556 | 96729,95173,90081 |
| 1d | 89552 | 2335 | 46.7 | Low | 89180, 86628, 88300, 89197, 89552 | 90351/91292/94685/98408 | 84031 | 78079-108612 | 117669,108871,104214 |
| 1w | 89552 | 8219 | 41.9 | Low | 91497, 90964, 93614, 86628, 89552 | 96120/96741/86238/68608 | 20171 | 14654-61237 | 63076,42236,27526 |

ã€å†å²æ€è·¯å›æº¯ (Context)ã€‘
ä»¥ä¸‹æ˜¯æœ€è¿‘ 3 æ¬¡çš„åˆ†æè®°å½•ï¼Œè¯·å‚è€ƒè¿‡å»çš„æ—¶é—´çº¿å’Œæ€è·¯æ¼”å˜ï¼š
----------------------------------------
 [2026-01-28 16:00:37] qwen3-max-2026-01-23: [STRATEGY] Trend: ä¸­é•¿æœŸä¸‹é™é€šé“ï¼Œä½†æ—¥çº¿çº§åˆ«æ¥è¿‘å…³é”®éœ€æ±‚åŒº
Predict: è‹¥æœªæ¥ä»·æ ¼å›æ’¤è‡³86500-87000å¹¶å‡ºç°ç»“æ„æ€§çœ‹æ¶¨ç¡®è®¤ï¼ˆå¦‚pin barã€åæ²¡ã€åŒåº•ç­‰ï¼‰ï¼Œåˆ™å¯é‡æ–°éƒ¨ç½²é«˜ç›ˆäºæ¯”å¤šå•ï¼›å¦åˆ™ç»´æŒè§‚æœ›ã€‚ | Logic: å½“å‰ä»·æ ¼89108å·²è¿œç¦»æ­¤å‰æŒ‚å•åŒºåŸŸ86750ï¼Œä¸”æœªå‡ºç°å›è°ƒè‡³ç†æƒ³å¤šå¤´å…¥åœºåŒºã€‚ç»“åˆ4hä¸æ—¥çº¿EMAä»ä¸ºç©ºå¤´æ’åˆ—ï¼ŒçŸ­æœŸç¼ºä¹åšå¤šåŠ¨èƒ½ã€‚åŸæŒ‚å•é€»è¾‘åŸºäºæ·±åº¦å›è¸©åç»“æ„ç¡®è®¤ï¼Œä½†å½“å‰ä»·æ ¼æœªè§¦å‘è¯¥æ¡ä»¶ï¼Œä¸”å¸‚åœºæ— æ˜æ˜¾åè½¬ä¿¡å·ï¼Œç»§ç»­æŒæœ‰æŒ‚å•å°†é™ä½èµ„é‡‘æ•ˆç‡å¹¶å¢åŠ æ— æ•ˆæš´éœ²é£é™©ã€‚å› æ­¤åº”å–æ¶ˆæ—§æŒ‚å•ï¼Œç­‰å¾…æ›´æ¸…æ™°çš„ç»“æ„ä¿¡å·ã€‚
 [2026-01-28 15:00:40] qwen3-max-2026-01-23: [STRATEGY] Trend: ä¸­é•¿æœŸä¸‹é™é€šé“ï¼Œä½†æ—¥çº¿çº§åˆ«æ¥è¿‘å…³é”®éœ€æ±‚åŒº
Predict: BTCè‹¥å›è¸©86500-87000åŒºåŸŸè·å¾—æ”¯æ’‘ï¼Œæœ‰æœ›å±•å¼€ä¸­æœŸåå¼¹è‡³92000-95000åŒºé—´ | Logic: å½“å‰ä»·æ ¼å°šæœªå›è¸©ç†æƒ³å¤šå¤´å…¥åœºåŒºï¼Œè‹¥å›è°ƒè‡³86500-87000å¹¶å‡ºç°ç»“æ„ç¡®è®¤ï¼Œåˆ™å…·å¤‡é«˜ç›ˆäºæ¯”åšå¤šæœºä¼š
----------------------------------------

ã€è¾“å‡ºè¦æ±‚ã€‘
æ€è·¯ è§£è¯» ä¸­æ–‡æè¿°
è¯·è¾“å‡º JSONã€‚
- `action`: BUY_LIMIT / SELL_LIMIT / CANCEL / NO_ACTION
- `cancel_order_id`: å¦‚æœ action æ˜¯ CANCELï¼Œè¯·å¡«å†™è¦æ’¤é”€çš„å•æ® IDã€‚
- `entry_price`: å»ºè®®å…¥åœºä»·
- `take_profit`: å»ºè®®æ­¢ç›ˆä»· (å¿…å¡«)
- `stop_loss`: å»ºè®®æ­¢æŸä»· (å¿…å¡«)
- `reason`: è¯¦ç»†çš„ç­–ç•¥é€»è¾‘ï¼ŒåŒ…å« R/R è®¡ç®—ã€‚
"""

# ==========================================
# 3. æ‰§è¡Œæµ‹è¯•é€»è¾‘
# ==========================================

def test_llm_connection():
    logger.info(f"\nğŸš€ å¼€å§‹æµ‹è¯• LLM é…ç½® (.env)")
    
    api_key = API_KEY
    base_url = BASE_URL
    model_name = MODEL_NAME
    
    logger.info(f"   Model: {model_name}")
    logger.info(f"   Base URL: {base_url}")
    logger.info(f"   API Key: {api_key[:6]}******" if api_key else "   âŒ API Key æœªæ‰¾åˆ°")

    # åˆå§‹åŒ– LLM
    try:
        llm = ChatOpenAI(
            model=model_name,
            api_key=api_key,
            base_url=base_url,
            temperature=0
        ).with_structured_output(AgentOutput,method="function_calling") # å°è¯•ä½¿ç”¨tool useæ–¹å¼
        
        logger.info("âœ… LLM å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ")
        return llm
    except Exception as e:
        logger.error(f"âŒ LLM åˆå§‹åŒ–å¤±è´¥: {e}")
        return None

def run_test(llm, test_name, prompt_content):
    logger.info(f"\n------------------------------------------------")
    logger.info(f"ğŸ§ª æµ‹è¯•åœºæ™¯: {test_name}")
    logger.info(f"------------------------------------------------")
    logger.info("â³ æ­£åœ¨å‘é€è¯·æ±‚ç»™ LLM (è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ)...")
    
    start_t = time.time()
    try:
        # å‘é€ SystemMessage
        response = llm.invoke([SystemMessage(content=prompt_content)])
        
        # æ‰“å°ç»“æœ
        logger.info(f"âœ… å“åº”æˆåŠŸ (è€—æ—¶ {time.time()-start_t:.2f}s)")
        logger.info("\nğŸ‘‡ LLM è¿”å›çš„ JSON æ•°æ®:")
        logger.info(response)
        logger.info(json.dumps(response.model_dump(), indent=2, ensure_ascii=False))
        
        # ç®€å•çš„é€»è¾‘æ£€æŸ¥
        if response.orders:
            logger.info(f"\nğŸ’¡ ç”Ÿæˆäº† {len(response.orders)} ä¸ªè®¢å•æŒ‡ä»¤ã€‚")
        else:
            logger.info("\nğŸ’¡ æœªç”Ÿæˆè®¢å• (NO_ACTION æˆ– è§‚æœ›)ã€‚")
            
    except Exception as e:
        logger.error(f"âŒ è°ƒç”¨å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    llm_client = test_llm_connection()
    
    if llm_client:
        # æµ‹è¯• 1: å®ç›˜æ¨¡å¼
        run_test(llm_client, "å®ç›˜æ¨¡å¼ (ETH/USDT)", REAL_PROMPT_INPUT)
        
        # ä¼‘æ¯ä¸€ä¸‹é¿å…é€Ÿç‡é™åˆ¶
        time.sleep(1)
        
        # æµ‹è¯• 2: ç­–ç•¥æ¨¡å¼
        run_test(llm_client, "ç­–ç•¥æ¨¡å¼ (BTC/USDT)", STRATEGY_PROMPT_TEMPLATE)